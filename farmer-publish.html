<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>邮粮通 - 发布销售</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js"></script>
    <style>
        /* 品类标签 - 与收购商发布需求页保持一致 */
        .category-tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
            white-space: nowrap;
        }
        .category-tag:active {
            transform: scale(0.95);
        }
        /* 品类颜色 - 未选中状态 */
        .category-tag.bg-red-50 { background: #FEE2E2; color: #EF4444; }
        .category-tag.bg-green-50 { background: #DCFCE7; color: #22C55E; }
        .category-tag.bg-amber-50 { background: #FEF3C7; color: #F59E0B; }
        .category-tag.bg-violet-50 { background: #EDE9FE; color: #8B5CF6; }
        .category-tag.bg-orange-50 { background: #FFE4D6; color: #F97316; }
        .category-tag.bg-gray-100 { background: #F3F4F6; color: #6B7280; }
        /* 选中状态 - 保持品类颜色 + 边框 + 轻阴影 */
        .category-tag.active {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            font-weight: 600;
        }
        .category-tag.active.border-red-200 { border-color: #FECACA; }
        .category-tag.active.border-green-200 { border-color: #BBF7D0; }
        .category-tag.active.border-amber-200 { border-color: #FDE68A; }
        .category-tag.active.border-violet-200 { border-color: #DDD6FE; }
        .category-tag.active.border-orange-200 { border-color: #FED7AA; }
        .category-tag.active.border-gray-200 { border-color: #E5E7EB; }

        /* 输入框样式 */
        .custom-input {
            width: 100%;
            background: #F3F4F6;
            border: 1px solid transparent;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            color: #1F2937;
            outline: none;
            transition: all 0.2s ease;
        }
        .custom-input:focus {
            border-color: #11A64A;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(17, 166, 74, 0.08);
        }
        .custom-input::placeholder {
            color: #9CA3AF;
        }

        /* Toast 提示 */
        .toast-tip {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            padding: 12px 20px;
            background: rgba(17, 24, 39, 0.9);
            border-radius: 10px;
            color: #fff;
            font-size: 13px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .toast-tip.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    </style>
</head>
<body>
<div class="mobile-container">
    <div id="statusBar"></div>
    <div id="navBar"></div>

    <!-- 主内容区 -->
    <div class="flex-1 overflow-y-auto no-scrollbar px-4 pb-4" style="padding-bottom:80px;">

        <!-- 单一卡片容器 -->
        <div class="glass-panel rounded-2xl mt-3 overflow-hidden">

            <!-- 区块1：品类选择 -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-apple-whole text-gray-400 text-sm"></i>
                    <span class="text-sm font-medium text-gray-700">销售品类 <span class="text-red-400">*</span></span>
                </div>
                <div class="grid grid-cols-4 gap-2" id="cateGrid">
                    <div class="category-tag bg-red-50 text-red-500" data-cate="水果" data-border="border-red-200" onclick="selectCate(this)">
                        <i class="fas fa-apple-whole text-xs"></i>水果
                    </div>
                    <div class="category-tag bg-green-50 text-green-500" data-cate="蔬菜" data-border="border-green-200" onclick="selectCate(this)">
                        <i class="fas fa-carrot text-xs"></i>蔬菜
                    </div>
                    <div class="category-tag bg-amber-50 text-amber-500" data-cate="粮油" data-border="border-amber-200" onclick="selectCate(this)">
                        <i class="fas fa-wheat-awn text-xs"></i>粮油
                    </div>
                    <div class="category-tag bg-violet-50 text-violet-500" data-cate="禽蛋" data-border="border-violet-200" onclick="selectCate(this)">
                        <i class="fas fa-egg text-xs"></i>禽蛋
                    </div>
                    <div class="category-tag bg-orange-50 text-orange-500" data-cate="肉类" data-border="border-orange-200" onclick="selectCate(this)">
                        <i class="fas fa-drumstick-bite text-xs"></i>肉类
                    </div>
                    <div class="category-tag bg-gray-100 text-gray-500" data-cate="其他" data-border="border-gray-200" onclick="selectCate(this)">
                        <i class="fas fa-box-open text-xs"></i>其他
                    </div>
                </div>
            </div>

            <!-- 分割线 -->
            <div class="border-t border-gray-100"></div>

            <!-- 区块2：销售标题 -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-edit text-gray-400 text-sm"></i>
                    <span class="text-sm font-medium text-gray-700">销售标题 <span class="text-red-400">*</span></span>
                </div>
                <input type="text" id="titleInput" class="custom-input mb-2" placeholder="如：出售新鲜红富士苹果" maxlength="20">
                <div class="flex justify-end">
                    <span class="text-[10px] text-gray-400" id="titleCount">0/20</span>
                </div>
            </div>

            <!-- 分割线 -->
            <div class="border-t border-gray-100"></div>

            <!-- 区块3：描述（选填） -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-note-sticky text-gray-400 text-sm"></i>
                    <span class="text-sm font-medium text-gray-700">销售描述 <span class="text-gray-400 text-xs font-normal">（选填）</span></span>
                </div>
                <textarea id="noteInput" rows="2" class="custom-input resize-none" placeholder="补充描述品种、规格、质量要求、交货时间等"></textarea>
            </div>

            <!-- 分割线 -->
            <div class="border-t border-gray-100"></div>

            <!-- 区块4：数量 -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-weight-hanging text-gray-400 text-sm"></i>
                    <span class="text-sm font-medium text-gray-700">销售数量 <span class="text-red-400">*</span></span>
                </div>
                <div class="flex gap-3">
                    <input type="number" id="qtyInput" class="custom-input flex-1" placeholder="请输入数量">
                    <select id="unitSelect" class="custom-input w-24 text-center" onchange="updatePricePlaceholder()">
                        <option value="斤">斤</option>
                        <option value="公斤">公斤</option>
                        <option value="吨">吨</option>
                        <option value="箱">箱</option>
                        <option value="袋">袋</option>
                        <option value="个">个</option>
                        <option value="件">件</option>
                        <option value="捆">捆</option>
                        <option value="框">框</option>
                    </select>
                </div>
            </div>

            <!-- 分割线 -->
            <div class="border-t border-gray-100"></div>

            <!-- 区块5：销售单价（选填） -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-tag text-gray-400 text-sm"></i>
                    <span class="text-sm font-medium text-gray-700">销售单价 <span class="text-gray-400 text-xs font-normal">（选填）</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-sm">¥</span>
                    <input type="number" id="priceInput" step="0.01" class="custom-input" placeholder="元/斤，不填表示面议">
                </div>
                <p class="text-[10px] text-gray-400 mt-2">
                    <i class="fas fa-info-circle mr-0.5"></i>
                    价格为每<span id="unitLabel">斤</span>的单价，不填表示面议
                </p>
            </div>

            <!-- 分割线 -->
            <div class="border-t border-gray-100"></div>

            <!-- 区块6：发布地址 -->
            <div class="p-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-location-dot text-gray-400 text-sm"></i>
                    <span class="text-sm font-medium text-gray-700">销售地址 <span class="text-red-400">*</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" id="locationInput" class="custom-input flex-1" placeholder="请输入发布地址">
                    <button id="locateBtn" type="button" class="shrink-0 px-3 py-2 text-xs font-medium rounded-lg border border-primary/30 text-primary bg-primary/5" onclick="fillCurrentLocation()">
                        <i class="fas fa-location-crosshairs mr-1"></i>定位
                    </button>
                </div>
            </div>

        </div>

        <!-- 提示文字 -->
        <div class="mt-3 px-1">
            <p class="text-xs text-gray-400">
                <i class="fas fa-info-circle mr-0.5"></i>
                最多同时发布20条进行中销售需求
            </p>
        </div>

    </div>

    <!-- 底部发布按钮 -->
    <div id="submitBar" class="absolute bottom-0 left-0 right-0 px-4 py-3 bg-gradient-to-t from-[#FFFBF0] via-[#FFFBF0] to-transparent">
        <button id="submitBtn" class="w-full py-2.5 bg-primary text-white font-medium text-sm rounded-2xl shadow-glow active:scale-[0.98] transition-transform" onclick="submitDemand()">
            <i class="fas fa-paper-plane mr-1"></i>确认发布
        </button>
    </div>

    <div id="toastTip" class="toast-tip"></div>
</div>

<script>
const demandStore = window.DemandMockStore || null;
const q = new URLSearchParams(window.location.search);
const mode = q.get('mode') || '';
const isEdit = mode === 'edit';
const isView = mode === 'view';
const editId = q.get('id');
const fromPage = q.get('from') || '';
const sourcePage = q.get('source') || '';
const editingDemand = (isEdit || isView) && demandStore && typeof demandStore.findDemandById === 'function'
    ? demandStore.findDemandById(editId)
    : null;
let selectedCategory = '';

// 动态返回链接优先级：from > source > 默认
let backLink = 'farmer-market.html';
if ((isEdit || isView) && fromPage === 'manage') {
    backLink = 'farmer-demand-manage.html';
} else if (sourcePage === 'home') {
    backLink = 'farmer-home.html';
} else if (sourcePage === 'my') {
    backLink = 'farmer-my.html';
}

document.getElementById('statusBar').innerHTML = renderStatusBar();
document.getElementById('navBar').innerHTML = renderHeader(isView ? '销售详情' : (isEdit ? '编辑销售需求' : '发布销售需求'), backLink);

if (isEdit) {
    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-1"></i>保存销售需求';
}

if (isView) {
    lockReadonlyView();
}

// 标题字数统计
document.getElementById('titleInput').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('titleCount').textContent = count + '/20';
    if (count >= 20) {
        document.getElementById('titleCount').classList.add('text-red-400');
        document.getElementById('titleCount').classList.remove('text-gray-400');
    } else {
        document.getElementById('titleCount').classList.remove('text-red-400');
        document.getElementById('titleCount').classList.add('text-gray-400');
    }
});

if (editingDemand && editingDemand.role === 'farmer') {
    hydrateForm(editingDemand);
}

function lockReadonlyView() {
    var submitBar = document.getElementById('submitBar');
    if (submitBar) submitBar.classList.add('hidden');

    document.querySelectorAll('.category-tag').forEach(function(tag) {
        tag.removeAttribute('onclick');
        tag.classList.remove('active:scale-95');
        tag.style.cursor = 'default';
    });

    var titleInput = document.getElementById('titleInput');
    var noteInput = document.getElementById('noteInput');
    var locationInput = document.getElementById('locationInput');
    var locateBtn = document.getElementById('locateBtn');
    var qtyInput = document.getElementById('qtyInput');
    var priceInput = document.getElementById('priceInput');
    var unitSelect = document.getElementById('unitSelect');

    if (titleInput) titleInput.readOnly = true;
    if (noteInput) noteInput.readOnly = true;
    if (locationInput) locationInput.readOnly = true;
    if (locateBtn) locateBtn.classList.add('hidden');
    if (qtyInput) qtyInput.readOnly = true;
    if (priceInput) priceInput.readOnly = true;
    if (unitSelect) unitSelect.disabled = true;
}

function selectCate(el) {
    if (isView) return;
    document.querySelectorAll('.category-tag').forEach(b => {
        b.classList.remove('active');
        // 移除所有可能的边框类
        b.classList.remove('border-red-200', 'border-green-200', 'border-amber-200', 'border-violet-200', 'border-orange-200', 'border-gray-200');
    });
    el.classList.add('active');
    // 添加对应的边框类
    const borderClass = el.getAttribute('data-border');
    if (borderClass) {
        el.classList.add(borderClass);
    }
    selectedCategory = el.getAttribute('data-cate') || '';
}

function updatePricePlaceholder() {
    const unit = document.getElementById('unitSelect').value;
    document.getElementById('unitLabel').textContent = unit;
    document.getElementById('priceInput').placeholder = '元/' + unit + '，不填表示面议';
}

function hydrateForm(demand) {
    selectedCategory = demand.category || '';
    document.querySelectorAll('.category-tag').forEach(btn => {
        const isActive = (btn.getAttribute('data-cate') || '') === selectedCategory;
        btn.classList.toggle('active', isActive);
        // 移除所有边框类
        btn.classList.remove('border-red-200', 'border-green-200', 'border-amber-200', 'border-violet-200', 'border-orange-200', 'border-gray-200');
        // 如果选中，添加对应的边框类
        if (isActive) {
            const borderClass = btn.getAttribute('data-border');
            if (borderClass) {
                btn.classList.add(borderClass);
            }
        }
    });

    document.getElementById('unitSelect').value = demand.unit || '斤';
    updatePricePlaceholder();

    document.getElementById('titleInput').value = demand.title || '';
    document.getElementById('titleCount').textContent = (demand.title || '').length + '/20';
    document.getElementById('locationInput').value = demand.location || '';
    document.getElementById('qtyInput').value = demand.qty || '';
    document.getElementById('priceInput').value = demand.price === null || demand.price === undefined ? '' : demand.price;
    document.getElementById('noteInput').value = demand.note || '';
}

function fillCurrentLocation() {
    if (isView) return;
    var input = document.getElementById('locationInput');
    if (!input) return;

    var fallback = '河北省保定市莲池区（模拟定位）';
    if (!navigator.geolocation) {
        input.value = fallback;
        showToast('定位能力不可用，已填入默认地址');
        return;
    }

    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = Number(position.coords.latitude || 0).toFixed(6);
        var lng = Number(position.coords.longitude || 0).toFixed(6);
        input.value = '定位坐标：' + lat + ', ' + lng;
        showToast('定位成功，请按需补充详细地址');
    }, function() {
        input.value = fallback;
        showToast('定位失败，已填入默认地址');
    }, { enableHighAccuracy: true, timeout: 5000 });
}

function showToast(msg) {
    const tip = document.getElementById('toastTip');
    tip.textContent = msg;
    tip.classList.add('show');
    clearTimeout(showToast.timer);
    showToast.timer = setTimeout(() => tip.classList.remove('show'), 2000);
}

function submitDemand() {
    if (isView) return;
    const title = document.getElementById('titleInput').value.trim();
    const location = document.getElementById('locationInput').value.trim();
    const qty = Number(document.getElementById('qtyInput').value);
    const priceRaw = document.getElementById('priceInput').value.trim();
    const unit = document.getElementById('unitSelect').value;
    const note = document.getElementById('noteInput').value.trim();

    if (!selectedCategory) {
        showToast('请选择品类');
        return;
    }
    if (!title) {
        showToast('请填写销售标题');
        return;
    }
    if (!location) {
        showToast('请填写发布地址');
        return;
    }
    if (!qty || qty <= 0) {
        showToast('请输入有效数量');
        return;
    }

    const payload = {
        role: 'farmer',
        category: selectedCategory,
        title: title,
        location: location,
        qty: qty,
        unit: unit,
        price: priceRaw ? Number(priceRaw) : null,
        note: note
    };

    if (demandStore && typeof demandStore.createDemand === 'function') {
        if (isEdit && editingDemand && editingDemand.role === 'farmer' && typeof demandStore.updateDemand === 'function') {
            demandStore.updateDemand(editingDemand.id, payload);
        } else {
            demandStore.createDemand(payload);
        }
    }

    const jump = new URLSearchParams({ saved: '1' });
    if (isEdit) jump.set('mode', 'edit');
    window.location.href = 'farmer-demand-manage.html?' + jump.toString();
}
</script>
</body>
</html>
