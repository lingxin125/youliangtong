<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微邮付 - PC 收银台</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #11A64A;
            --brand-strong: #0a7532;
            --accent: #F59E0B;
            --bg: #F7F8FA;
            --panel: #FFFFFF;
            --line: #F3F4F6;
            --text: #1F2937;
            --muted: #6B7280;
            --danger: #EF4444;
            --warning: #F59E0B;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            color: var(--text);
            font-family: "Poppins", "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page-shell {
            max-width: 1240px;
            margin: 0 auto;
            padding: 24px;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand-mark {
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 1px solid #e6e8ee;
            border-radius: 12px;
            padding: 4px;
            overflow: hidden;
        }

        .brand-mark img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .brand-title {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.4px;
        }

        .brand-sub {
            margin-top: 2px;
            color: var(--muted);
            font-size: 13px;
        }

        .topbar-note {
            font-size: 12px;
            color: var(--brand);
            font-weight: 700;
            line-height: 1.6;
            text-align: right;
            white-space: nowrap;
        }

        .layout {
            margin-top: 18px;
            display: grid;
            grid-template-columns: 360px minmax(0, 1fr);
            gap: 18px;
            align-items: start;
        }

        .preset-float {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 84;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .preset-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 1px solid #8bc3a1;
            background: linear-gradient(135deg, #159245, #117a37);
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(17, 122, 55, 0.28);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .preset-fab:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 28px rgba(17, 122, 55, 0.32);
        }

        .preset-fab.active {
            background: linear-gradient(135deg, #0d622d, #0b4f23);
        }

        .preset-popover {
            width: 262px;
            border-radius: 14px;
            border: 1px solid var(--line);
            background: var(--panel);
            box-shadow: var(--shadow);
            padding: 12px;
            display: none;
        }

        .preset-popover.show {
            display: block;
        }

        .preset-popover-title {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .preset-popover-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preset-btn {
            border: 1px solid #d9d3c6;
            background: #fff;
            color: #4b5563;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            border-color: #b8ad95;
            color: #1f2937;
        }

        .preset-btn.active {
            border-color: #98cfac;
            color: var(--brand-strong);
            background: rgba(17, 122, 55, 0.12);
        }

        .left-col {
            position: sticky;
            top: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .panel-title {
            margin: 0;
            padding: 14px 16px;
            border-bottom: 1px solid var(--line);
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            background: linear-gradient(180deg, rgba(17, 122, 55, 0.04), transparent);
        }

        .amount-panel {
            padding: 18px 16px;
            text-align: center;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            padding: 4px 11px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .status-badge.pending { background: #fff7ed; color: var(--warning); border: 1px solid #fed7aa; }
        .status-badge.success { background: #edfdf2; color: var(--brand); border: 1px solid #b7ebc7; }
        .status-badge.failed,
        .status-badge.canceled { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }

        .amount-label {
            color: var(--muted);
            font-size: 13px;
        }

        .amount-value {
            margin: 6px 0 2px;
            font-family: "Poppins", sans-serif;
            color: #111827;
            font-size: 38px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .amount-value .currency {
            font-size: 24px;
            margin-right: 2px;
        }

        .countdown-row {
            margin-top: 10px;
            color: var(--warning);
            font-size: 12px;
        }

        .countdown-row.expired {
            color: var(--danger);
        }

        .info-list {
            padding: 8px 16px 12px;
        }

        .info-item {
            padding: 10px 0;
            border-bottom: 1px dashed #eee5d3;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: flex-start;
            font-size: 13px;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--muted);
            flex-shrink: 0;
        }

        .info-value {
            color: #111827;
            text-align: right;
            word-break: break-all;
        }

        .items-wrap {
            padding: 6px 14px 14px;
            max-height: 270px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead th {
            color: #9ca3af;
            font-weight: 500;
            text-align: left;
            padding: 7px 4px;
            border-bottom: 1px solid #efe8d8;
            white-space: nowrap;
        }

        thead th:last-child,
        tbody td:last-child {
            text-align: right;
        }

        tbody td {
            padding: 9px 4px;
            border-bottom: 1px solid #f6f1e8;
            color: #374151;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .item-total {
            padding: 12px 16px;
            border-top: 1px solid var(--line);
            background: #fbfaf6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .item-total strong {
            font-family: "Poppins", sans-serif;
            color: var(--brand-strong);
            font-size: 18px;
        }

        .payment-head {
            padding: 14px 16px 0;
        }

        .payment-title {
            margin: 0 0 4px;
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .payment-sub {
            margin: 0 0 14px;
            color: var(--muted);
            font-size: 13px;
        }

        .method-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid var(--line);
            padding: 0 16px 12px;
        }

        .tab-btn {
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #4b5563;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            border-color: #c6d9cc;
            color: #1f2937;
        }

        .tab-btn.active {
            background: rgba(17, 122, 55, 0.1);
            color: var(--brand-strong);
            border-color: #9fd8b1;
            box-shadow: inset 0 0 0 1px rgba(17, 122, 55, 0.12);
        }

        .pay-panel {
            display: none;
            padding: 18px 16px;
        }

        .pay-panel.active {
            display: block;
        }

        .pay-grid {
            display: grid;
            grid-template-columns: minmax(250px, 320px) minmax(0, 1fr);
            gap: 20px;
            align-items: center;
        }

        .guide-area {
            border: 1px solid #e8e3d8;
            border-radius: 14px;
            background: linear-gradient(180deg, #fff, #f9fafb);
            padding: 20px 16px;
            min-height: 286px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: left;
        }

        .guide-kicker {
            display: inline-flex;
            align-items: center;
            width: fit-content;
            margin-bottom: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(17, 122, 55, 0.22);
            background: rgba(17, 122, 55, 0.08);
            color: var(--brand-strong);
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }

        .guide-title {
            margin: 0 0 8px;
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .guide-message {
            margin: 0 0 12px;
            font-size: 13px;
            color: #374151;
            line-height: 1.7;
        }

        #orderPayCompanyName {
            color: var(--danger);
        }

        .guide-steps {
            margin: 0;
            padding-left: 18px;
            color: #6b7280;
            font-size: 12px;
            line-height: 1.8;
        }

        .qr-area {
            border: 1px solid #e8e3d8;
            border-radius: 14px;
            background: #fff;
            padding: 16px;
            text-align: center;
        }

        .qr-box {
            width: 220px;
            height: 220px;
            margin: 0 auto 14px;
            border: 1px solid #ded6c4;
            border-radius: 14px;
            background:
                linear-gradient(135deg, rgba(17, 122, 55, 0.05), rgba(197, 164, 90, 0.1)),
                repeating-linear-gradient(0deg, #fff, #fff 8px, #f8f5ed 8px, #f8f5ed 16px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
        }

        .qr-amount {
            font-family: "Poppins", sans-serif;
            font-size: 30px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .qr-tip {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.6;
        }

        .channel-meta {
            border: 1px solid #efe7d4;
            border-radius: 14px;
            background: #fcfaf4;
            padding: 14px 16px;
        }

        .channel-meta h4 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #374151;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 7px 0;
            border-bottom: 1px dashed #eadfc8;
            font-size: 13px;
        }

        .meta-row:last-child {
            border-bottom: none;
        }

        .meta-row .k { color: var(--muted); }
        .meta-row .v { color: #111827; text-align: right; }
        .meta-row .v.strong {
            color: var(--brand-strong);
            font-family: "Poppins", sans-serif;
            font-size: 20px;
            font-weight: 700;
        }

        .action-row {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            border-radius: 10px;
            border: 1px solid transparent;
            padding: 11px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand);
        }

        .btn-primary:hover {
            background: var(--brand-strong);
            border-color: var(--brand-strong);
        }

        .btn-secondary {
            background: #fff;
            border-color: #d7cfbc;
            color: #4b5563;
        }

        .btn-secondary:hover {
            border-color: #b7ab8f;
            color: #111827;
        }

        .btn-danger {
            background: #fff1f2;
            border-color: #fecdd3;
            color: var(--danger);
        }

        .btn-danger:hover {
            background: #ffe4e6;
        }

        .btn:disabled,
        .btn.is-disabled {
            cursor: not-allowed;
            background: #e5e7eb;
            border-color: #e5e7eb;
            color: #9ca3af;
        }

        .form-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(300px, 420px);
            gap: 18px;
            align-items: start;
        }

        .form-card {
            border: 1px solid #ece5d7;
            border-radius: 14px;
            background: #fff;
            padding: 14px 16px;
        }

        .form-card h4 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #374151;
        }

        .input-group {
            margin-top: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #6b7280;
        }

        .input-group input {
            width: 100%;
            border: 1px solid #d5dbe3;
            border-radius: 10px;
            padding: 11px 12px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-group input:focus {
            border-color: #7fbf95;
            box-shadow: 0 0 0 3px rgba(17, 122, 55, 0.12);
        }

        .pay-note {
            padding: 11px 12px;
            border-radius: 10px;
            border: 1px solid #fde68a;
            background: #fffbeb;
            color: #92400e;
            font-size: 12px;
            line-height: 1.6;
        }

        .footer {
            margin-top: auto;
            padding-top: 16px;
            text-align: center;
            font-size: 12px;
            color: #8b8f97;
        }

        .toast {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 80;
            background: rgba(17, 24, 39, 0.9);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            opacity: 0;
            transform: translateY(-6px);
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 90;
            background: rgba(15, 23, 42, 0.46);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            width: min(460px, 100%);
            background: #fff;
            border-radius: 18px;
            border: 1px solid #e7e0d1;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.2);
            padding: 22px 20px;
        }

        .scan-modal .modal-content {
            width: min(420px, 100%);
        }

        .modal-icon {
            width: 66px;
            height: 66px;
            border-radius: 50%;
            margin: 0 auto 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: 700;
        }

        .modal-icon.success {
            background: #edfdf2;
            color: var(--brand);
        }

        .modal-icon.failed {
            background: #fef2f2;
            color: var(--danger);
        }

        .modal-icon.loading {
            border: 3px solid #e5e7eb;
            border-top-color: var(--brand);
            background: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-title {
            margin: 0;
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            color: #111827;
        }

        .modal-amount {
            margin: 8px 0 4px;
            text-align: center;
            font-family: "Poppins", sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #111827;
        }

        .modal-desc {
            text-align: center;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.7;
            margin-bottom: 14px;
        }

        .result-meta {
            border: 1px solid #efe8d8;
            border-radius: 12px;
            padding: 10px 12px;
            background: #faf8f2;
            margin-bottom: 14px;
        }

        .result-meta .meta-row {
            border-color: #e5dbc3;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 1100px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .left-col {
                position: static;
            }

            .pay-grid,
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 700px) {
            .page-shell {
                padding: 14px;
            }

            .topbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .topbar-note {
                text-align: left;
                white-space: normal;
            }

            .qr-box {
                width: 186px;
                height: 186px;
            }

            .preset-float {
                right: 14px;
                bottom: 14px;
            }

            .preset-popover {
                width: min(82vw, 252px);
            }
        }
    </style>
</head>
<body>
    <div class="page-shell">
        <header class="topbar">
            <div class="brand">
                <div class="brand-mark"><img src="./logo.svg" alt="微邮付 Logo"></div>
                <div>
                    <h1 class="brand-title">微邮付收银台</h1>
                    <div class="brand-sub">农产品交易结算中心</div>
                </div>
            </div>
            <div class="topbar-note">交易全程加密，请在有效期内完成支付</div>
        </header>

        <main class="layout">
            <aside class="left-col">
                <section class="panel amount-panel">
                    <div id="payStatusBadge" class="status-badge pending">待支付</div>
                    <div class="amount-label">应付金额</div>
                    <div class="amount-value">
                        <span class="currency">¥</span><span id="totalAmount">0.00</span>
                    </div>
                    <div id="countdownHint" class="countdown-row">请在 10天内完成支付</div>
                </section>

                <section class="panel">
                    <h2 class="panel-title">订单信息</h2>
                    <div class="info-list">
                        <div class="info-item"><span class="info-label">订单号</span><span id="orderNo" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">下单时间</span><span id="orderTime" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">付款人</span><span id="payerName" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">付款卡号</span><span id="payerCard" class="info-value">-</span></div>
                        <div class="info-item"><span class="info-label">付款银行</span><span id="payerBank" class="info-value">-</span></div>
                    </div>
                </section>
            </aside>

            <section class="panel">
                <div class="payment-head">
                    <h2 class="payment-title">选择支付方式</h2>
                </div>

                <div class="method-tabs">
                    <button class="tab-btn active" data-tab="bank">行业支付</button>
                    <button class="tab-btn" data-tab="orderpay">订单付</button>
                </div>

                <div id="panel-bank" class="pay-panel active">
                    <div class="pay-grid">
                        <div class="qr-area">
                            <div class="qr-box">银行转账二维码</div>
                            <div class="qr-amount">¥ <span class="pay-amount">0.00</span></div>
                            <div class="qr-tip">请使用邮储银行APP扫描上方二维码完成付款</div>
                        </div>
                        <div>
                            <div class="channel-meta">
                                <h4>行业支付信息</h4>
                                <div class="meta-row"><span class="k">收款人</span><span id="bankSellerName" class="v">-</span></div>
                                <div class="meta-row"><span class="k">收款银行</span><span id="bankSellerBank" class="v">-</span></div>
                                <div class="meta-row"><span class="k">收款人卡号</span><span class="v" id="bankSellerCard">-</span></div>
                            </div>
                            <div class="action-row">
                                <button class="btn btn-primary" data-pay-action onclick="openScanResult('bank')">已完成支付</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-orderpay" class="pay-panel">
                    <div class="pay-grid">
                        <div class="guide-area">
                            <div class="guide-kicker">企业网银支付引导</div>
                            <h3 class="guide-title">订单已发起</h3>
                            <p class="guide-message">请 <strong id="orderPayCompanyName" >“--”</strong> 登录企业网银完成订单支付。</p>
                            <ol class="guide-steps">
                                <li>进入企业网银，选择“待支付订单”。</li>
                                <li>核对订单号与金额后完成支付。</li>
                                <li>支付完成后返回本页刷新支付状态。</li>
                            </ol>
                        </div>
                        <div>
                            <div class="channel-meta">
                                <h4>收款人信息</h4>
                                <div class="meta-row"><span class="k">收款人</span><span id="orderPaySellerName" class="v">-</span></div>
                                <div class="meta-row"><span class="k">收款银行</span><span id="orderPaySellerBank" class="v">-</span></div>
                                <div class="meta-row"><span class="k">收款人卡号</span><span id="orderPaySellerCard" class="v">-</span></div>
                            </div>
                            <div class="action-row">
                                <button class="btn btn-primary" data-pay-action onclick="openScanResult('orderpay')">已完成支付</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div class="footer">© 2026 微邮付</div>
    </div>

    <div class="preset-float" id="presetFloat">
        <div id="presetPopover" class="preset-popover">
            <div class="preset-popover-title">演示预设</div>
            <div class="preset-popover-list">
                <button class="preset-btn active" data-preset="pending_basic" onclick="applyDemoPreset('pending_basic')">标准待支付</button>
                <button class="preset-btn" data-preset="pending_large" onclick="applyDemoPreset('pending_large')">大额订单付</button>
                <button class="preset-btn" data-preset="success_done" onclick="applyDemoPreset('success_done')">支付成功</button>
                <button class="preset-btn" data-preset="failed_case" onclick="applyDemoPreset('failed_case')">支付失败</button>
                <button class="preset-btn" data-preset="canceled_case" onclick="applyDemoPreset('canceled_case')">超时取消</button>
            </div>
        </div>
        <button id="presetFabBtn" class="preset-fab" type="button" aria-label="演示预设">预设</button>
    </div>

    <div id="toast" class="toast"></div>

    <div id="modalProcessing" class="modal">
        <div class="modal-content">
            <div class="modal-icon loading"></div>
            <h3 class="modal-title">支付处理中</h3>
            <div class="modal-desc">正在向银行发起交易请求，请稍候...</div>
        </div>
    </div>

    <div id="modalScan" class="modal scan-modal">
        <div class="modal-content">
            <h3 class="modal-title" style="font-size:20px;">支付结果模拟</h3>
            <div class="modal-desc">当前渠道：<strong id="scanChannelName" style="color:#111827;">行业支付</strong><br>请选择本次支付结果</div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="finishScan('success')">支付成功</button>
                <button class="btn btn-danger" onclick="finishScan('failed')">支付失败</button>
                <button class="btn btn-secondary" onclick="finishScan('pending')">继续待支付</button>
            </div>
        </div>
    </div>

    <div id="modalResult" class="modal">
        <div class="modal-content">
            <div id="resultIcon" class="modal-icon success">✓</div>
            <h3 id="resultTitle" class="modal-title">支付成功</h3>
            <div class="modal-amount">¥ <span id="resultAmount">0.00</span></div>
            <div id="resultDesc" class="modal-desc">订单已完成，感谢您的使用</div>
            <div class="result-meta">
                <div class="meta-row"><span class="k">订单号</span><span id="resultOrderNo" class="v">-</span></div>
                <div class="meta-row"><span class="k">支付方式</span><span id="resultMethod" class="v">-</span></div>
                <div class="meta-row"><span class="k">支付时间</span><span id="resultPaidAt" class="v">-</span></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="viewOrder()">查看订单</button>
                <button class="btn btn-primary" onclick="closeResult()">完成</button>
            </div>
        </div>
    </div>

    <script>
        const Config = {
            orderNo: 'PO202602240001',
            amount: 2580.00,
            createTime: formatTimeForView(new Date().toISOString()),
            timeout: 864000,
            summary: '小麦、玉米等 3 项商品',
            returnUrl: '',
            seller: {
                name: '李大姐',
                bankName: '邮储银行济南历城支行',
                card: '6228********8901'
            },
            payer: {
                name: '张老板',
                company: '保定收购站有限公司',
                card: '6210********7288',
                bank: '邮储银行保定清苑支行'
            },
            orderpay: {
                channel: '企业网银'
            },
            items: [
                { name: '小麦', qty: 800, unit: '斤', price: 1.45, subtotal: 1160.00 },
                { name: '玉米', qty: 600, unit: '斤', price: 1.35, subtotal: 810.00 },
                { name: '花生', qty: 200, unit: '斤', price: 3.05, subtotal: 610.00 }
            ]
        };

        const DEMO_PRESETS = {
            pending_basic: {
                label: '标准待支付',
                status: 'pending',
                tab: 'bank',
                timeout: 864000,
                amount: 2580.00,
                summary: '小麦、玉米等 3 项商品',
                seller: {
                    name: '李大姐',
                    bankName: '邮储银行济南历城支行',
                    card: '6228********8901'
                },
                items: [
                    { name: '小麦', qty: 800, unit: '斤', price: 1.45, subtotal: 1160.00 },
                    { name: '玉米', qty: 600, unit: '斤', price: 1.35, subtotal: 810.00 },
                    { name: '花生', qty: 200, unit: '斤', price: 3.05, subtotal: 610.00 }
                ]
            },
            pending_large: {
                label: '大额订单付',
                status: 'pending',
                tab: 'orderpay',
                timeout: 864000,
                amount: 128600.00,
                summary: '秋粮大宗订单 4 项商品',
                seller: {
                    name: '赵师傅',
                    bankName: '邮储银行保定清苑支行',
                    card: '6221********6608'
                },
                items: [
                    { name: '玉米', qty: 28000, unit: '斤', price: 1.52, subtotal: 42560.00 },
                    { name: '小麦', qty: 25000, unit: '斤', price: 1.68, subtotal: 42000.00 },
                    { name: '大豆', qty: 9000, unit: '斤', price: 3.10, subtotal: 27900.00 },
                    { name: '花生', qty: 3500, unit: '斤', price: 4.04, subtotal: 14140.00 }
                ]
            },
            success_done: {
                label: '支付成功',
                status: 'success',
                tab: 'bank',
                timeout: 900,
                amount: 9620.00,
                summary: '果蔬混采订单 3 项商品',
                seller: {
                    name: '王大哥',
                    bankName: '邮储银行潍坊寒亭支行',
                    card: '6210********1258'
                },
                items: [
                    { name: '西红柿', qty: 1600, unit: '斤', price: 2.20, subtotal: 3520.00 },
                    { name: '黄瓜', qty: 1400, unit: '斤', price: 2.10, subtotal: 2940.00 },
                    { name: '土豆', qty: 2100, unit: '斤', price: 1.50, subtotal: 3150.00 }
                ]
            },
            failed_case: {
                label: '支付失败',
                status: 'failed',
                tab: 'orderpay',
                timeout: 900,
                amount: 7600.00,
                summary: '蔬菜订单支付失败示例',
                seller: {
                    name: '孙阿姨',
                    bankName: '邮储银行德州齐河支行',
                    card: '6228********5721'
                },
                items: [
                    { name: '大白菜', qty: 3000, unit: '斤', price: 1.35, subtotal: 4050.00 },
                    { name: '萝卜', qty: 2100, unit: '斤', price: 1.10, subtotal: 2310.00 },
                    { name: '菠菜', qty: 620, unit: '斤', price: 2.00, subtotal: 1240.00 }
                ]
            },
            canceled_case: {
                label: '超时取消',
                status: 'canceled',
                tab: 'bank',
                timeout: 600,
                amount: 4380.00,
                summary: '超时未支付示例订单',
                seller: {
                    name: '刘师傅',
                    bankName: '邮储银行临沂兰山支行',
                    card: '6217********9813'
                },
                items: [
                    { name: '苹果', qty: 1200, unit: '斤', price: 2.10, subtotal: 2520.00 },
                    { name: '梨', qty: 900, unit: '斤', price: 1.45, subtotal: 1305.00 },
                    { name: '桃子', qty: 420, unit: '斤', price: 1.32, subtotal: 555.00 }
                ]
            }
        };

        let countdownTimer = null;
        let isExpired = false;
        let currentChannel = 'bank';
        let currentResultStatus = 'pending';
        let presetMenuOpen = false;

        function init() {
            parseParams();
            normalizeItems();
            bindTabs();
            bindPresetState();
            bindPresetFloating();
            renderAll();
            applyState('pending');
            startTimer();
        }

        function parseParams() {
            const p = new URLSearchParams(window.location.search);
            Config.returnUrl = p.get('returnUrl') || '';
            Config.orderNo = p.get('orderNo') || Config.orderNo;
            Config.summary = p.get('summary') || Config.summary;

            const amount = parseFloat(p.get('amount'));
            if (!Number.isNaN(amount) && amount > 0) {
                Config.amount = amount;
            }

            const createdAt = p.get('createdAt') || p.get('createTime');
            if (createdAt) {
                Config.createTime = formatTimeForView(createdAt);
            }

            const timeout = parseInt(p.get('timeout'), 10);
            if (!Number.isNaN(timeout) && timeout >= 60) {
                Config.timeout = timeout;
            }

            Config.seller.name = p.get('payeeName') || p.get('sellerName') || Config.seller.name;
            Config.seller.bankName = p.get('payeeBank') || p.get('bankName') || Config.seller.bankName;
            Config.seller.card = p.get('payeeCard') || Config.seller.card;
            Config.payer.name = p.get('payerName') || Config.payer.name;
            Config.payer.company = p.get('payerCompany') || p.get('companyName') || p.get('payerOrg') || Config.payer.company;
            Config.payer.card = p.get('payerCard') || p.get('payerAcct') || Config.payer.card;
            Config.payer.bank = p.get('payerBank') || Config.payer.bank;

            const rawItems = p.get('items');
            if (rawItems) {
                const parsed = parseItems(rawItems);
                if (parsed.length > 0) {
                    Config.items = parsed;
                }
            }
        }

        function parseItems(raw) {
            if (!raw) return [];
            const tries = [raw];
            try {
                tries.push(decodeURIComponent(raw));
            } catch (err) {
                // ignore decode failure
            }
            for (let i = 0; i < tries.length; i++) {
                try {
                    const parsed = JSON.parse(tries[i]);
                    if (Array.isArray(parsed)) return parsed;
                } catch (err) {
                    // keep trying
                }
            }
            return [];
        }

        function normalizeItems() {
            if (!Array.isArray(Config.items) || Config.items.length === 0) {
                Config.items = [{
                    name: Config.summary || '订单商品',
                    qty: 1,
                    unit: '单',
                    price: Number(Config.amount.toFixed(2)),
                    subtotal: Number(Config.amount.toFixed(2))
                }];
                return;
            }

            Config.items = Config.items.map((item, index) => {
                if (item && typeof item === 'object') {
                    const qty = Number(item.qty || item.quantity || 0);
                    const price = Number(item.price || 0);
                    let subtotal = Number(item.subtotal);
                    if (!Number.isFinite(subtotal) || subtotal <= 0) {
                        subtotal = Number(item.total);
                    }
                    if (!Number.isFinite(subtotal) || subtotal <= 0) {
                        subtotal = qty > 0 && price > 0 ? qty * price : 0;
                    }
                    if (!Number.isFinite(subtotal) || subtotal <= 0) {
                        subtotal = 0;
                    }

                    const unit = item.unit || '';
                    const name = String(item.name || ('商品' + (index + 1)));

                    if (item.spec && (!qty || !price)) {
                        return { name, qty: item.spec, unit: '', price: null, subtotal };
                    }

                    return { name, qty, unit, price, subtotal };
                }
                return {
                    name: '商品' + (index + 1),
                    qty: 1,
                    unit: '单',
                    price: 0,
                    subtotal: 0
                };
            });

            const total = Config.items.reduce((sum, item) => sum + (Number(item.subtotal) || 0), 0);
            if (total > 0) {
                Config.amount = Number(total.toFixed(2));
            }
        }

        function bindTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
        }

        function switchTab(tab) {
            currentChannel = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.pay-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === 'panel-' + tab);
            });
        }

        function renderAll() {
            setText('totalAmount', formatNum(Config.amount));
            setText('orderNo', Config.orderNo);
            setText('orderTime', Config.createTime);
            setText('payerName', Config.payer.name);
            setText('payerCard', Config.payer.card);
            setText('payerBank', Config.payer.bank);

            setText('bankSellerName', Config.seller.name);
            setText('bankSellerBank', Config.seller.bankName);
            setText('bankSellerCard', Config.seller.card);

            setText('orderPayCompanyName', '“' + Config.payer.company + '”');
            setText('orderPaySellerName', Config.seller.name);
            setText('orderPaySellerBank', Config.seller.bankName);
            setText('orderPaySellerCard', Config.seller.card);

            document.querySelectorAll('.pay-amount').forEach(el => {
                el.textContent = formatNum(Config.amount);
            });
        }

        function bindPresetState() {
            setActivePreset('pending_basic');
        }

        function setActivePreset(key) {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.preset === key);
            });
        }

        function bindPresetFloating() {
            const fab = document.getElementById('presetFabBtn');
            const popover = document.getElementById('presetPopover');
            if (!fab || !popover) return;

            fab.addEventListener('click', function(event) {
                event.stopPropagation();
                setPresetMenuOpen(!presetMenuOpen);
            });

            popover.addEventListener('click', function(event) {
                event.stopPropagation();
            });

            document.addEventListener('click', function() {
                setPresetMenuOpen(false);
            });

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    setPresetMenuOpen(false);
                }
            });
        }

        function setPresetMenuOpen(open) {
            presetMenuOpen = !!open;
            const fab = document.getElementById('presetFabBtn');
            const popover = document.getElementById('presetPopover');
            if (fab) {
                fab.classList.toggle('active', presetMenuOpen);
            }
            if (popover) {
                popover.classList.toggle('show', presetMenuOpen);
            }
        }

        function applyDemoPreset(key) {
            const preset = DEMO_PRESETS[key];
            if (!preset) return;

            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }

            Config.amount = preset.amount;
            Config.summary = preset.summary;
            Config.timeout = preset.timeout;
            Config.seller = Object.assign({}, Config.seller, preset.seller || {});
            Config.items = deepClone(preset.items || []);
            Config.createTime = formatTimeForView(new Date().toISOString());

            normalizeItems();
            renderAll();
            switchTab(preset.tab || 'bank');
            applyState(preset.status || 'pending');
            setActivePreset(key);
            clearModalAndInputs();
            setPresetMenuOpen(false);

            if ((preset.status || 'pending') === 'pending') {
                startTimer();
            }

            showToast('已切换为「' + preset.label + '」');
        }

        function clearModalAndInputs() {
            document.getElementById('modalProcessing').classList.remove('show');
            document.getElementById('modalScan').classList.remove('show');
            document.getElementById('modalResult').classList.remove('show');
        }

        function applyState(status) {
            const hint = document.getElementById('countdownHint');
            updateStatusBadge(status);

            if (status === 'pending') {
                isExpired = false;
                hint.classList.remove('expired');
                hint.textContent = '请在 ' + getTimeoutWindowLabel(Config.timeout) + '内完成支付';
                enablePayActions();
                return;
            }

            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }

            disablePayActions();

            if (status === 'success') {
                isExpired = false;
                hint.classList.remove('expired');
                hint.textContent = '该订单已支付完成';
                return;
            }

            if (status === 'failed') {
                isExpired = false;
                hint.classList.remove('expired');
                hint.textContent = '该订单支付失败，可切换其他预设继续演示';
                return;
            }

            isExpired = true;
            hint.classList.add('expired');
            hint.textContent = '订单已超时，系统已自动取消';
        }

        function startTimer() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            if (currentResultStatus !== 'pending') {
                return;
            }

            const baseTime = parseToDate(Config.createTime);
            const startTs = baseTime ? baseTime.getTime() : Date.now();
            const expireAt = startTs + Config.timeout * 1000;

            renderCountdown(expireAt);
            countdownTimer = setInterval(() => renderCountdown(expireAt), 1000);
        }

        function renderCountdown(expireAt) {
            const diff = expireAt - Date.now();
            const hint = document.getElementById('countdownHint');
            if (!hint) return;

            if (diff <= 0) {
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }
                isExpired = true;
                updateStatusBadge('canceled');
                hint.classList.add('expired');
                hint.textContent = '订单已超时，系统已自动取消';
                disablePayActions();
                return;
            }

            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            hint.classList.remove('expired');
            const remain = d + '天 ' + String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
            hint.textContent = '请在 ' + remain + ' 内完成支付';
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('payStatusBadge');
            if (!badge) return;
            const map = {
                pending: '待支付',
                success: '支付成功',
                failed: '支付失败',
                canceled: '已取消'
            };
            badge.className = 'status-badge ' + (status || 'pending');
            badge.textContent = map[status] || map.pending;
            currentResultStatus = status || 'pending';
        }

        function disablePayActions() {
            document.querySelectorAll('[data-pay-action]').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('is-disabled');
            });
        }

        function enablePayActions() {
            document.querySelectorAll('[data-pay-action]').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('is-disabled');
            });
        }

        function openScanResult(channel) {
            if (isExpired) {
                showToast('订单已超时，无法继续支付');
                return;
            }
            currentChannel = channel;
            setText('scanChannelName', channelLabel(channel));
            document.getElementById('modalScan').classList.add('show');
        }

        function finishScan(result) {
            document.getElementById('modalScan').classList.remove('show');

            if (result === 'pending') {
                showToast('订单保持待支付状态');
                return;
            }

            showProcessing();
            setTimeout(() => {
                hideProcessing();
                if (result === 'success') {
                    showResult('success', channelLabel(currentChannel), '');
                } else {
                    showResult('failed', channelLabel(currentChannel), '银行返回失败，请稍后重试');
                }
            }, 1100);
        }

        function showProcessing() {
            document.getElementById('modalProcessing').classList.add('show');
        }

        function hideProcessing() {
            document.getElementById('modalProcessing').classList.remove('show');
        }

        function showResult(status, method, reason) {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }

            updateStatusBadge(status);
            if (status !== 'success') {
                disablePayActions();
            }

            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const desc = document.getElementById('resultDesc');

            if (status === 'success') {
                icon.className = 'modal-icon success';
                icon.textContent = '✓';
                title.textContent = '支付成功';
                desc.textContent = '订单已完成，资金将按交易规则结算。';
            } else if (status === 'failed') {
                icon.className = 'modal-icon failed';
                icon.textContent = '!';
                title.textContent = '支付失败';
                desc.textContent = reason || '支付失败，请稍后重试。';
            } else {
                icon.className = 'modal-icon failed';
                icon.textContent = '!';
                title.textContent = '订单已取消';
                desc.textContent = reason || '订单已超时取消。';
            }

            setText('resultAmount', formatNum(Config.amount));
            setText('resultOrderNo', Config.orderNo);
            setText('resultMethod', method || '-');
            setText('resultPaidAt', formatTimeForView(new Date().toISOString()));

            document.getElementById('modalResult').classList.add('show');

            if (status === 'success' && window.parent !== window) {
                window.parent.postMessage({
                    type: 'PAYMENT_SUCCESS',
                    orderNo: Config.orderNo,
                    amount: Config.amount,
                    method: method || ''
                }, '*');
            }
        }

        function closeResult() {
            document.getElementById('modalResult').classList.remove('show');
            if (Config.returnUrl) {
                window.location.href = Config.returnUrl;
            }
        }

        function viewOrder() {
            if (Config.returnUrl) {
                window.location.href = Config.returnUrl;
                return;
            }
            showToast('演示环境未配置订单详情跳转地址');
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
            }
        }

        function channelLabel(channel) {
            const map = {
                bank: '行业支付',
                orderpay: '订单付',
            };
            return map[channel] || '支付';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            clearTimeout(showToast.timer);
            showToast.timer = setTimeout(() => {
                toast.classList.remove('show');
            }, 1800);
        }

        function formatNum(value) {
            const n = Number(value) || 0;
            return n.toLocaleString('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatMoney(value) {
            return '¥ ' + formatNum(value);
        }

        function getTimeoutWindowLabel(timeoutSec) {
            const sec = Number(timeoutSec) || 0;
            if (sec >= 86400 && sec % 86400 === 0) return (sec / 86400) + '天';
            if (sec >= 3600 && sec % 3600 === 0) return (sec / 3600) + '小时';
            if (sec >= 60) return Math.floor(sec / 60) + '分钟';
            return sec + '秒';
        }

        function parseToDate(raw) {
            if (!raw) return null;
            if (raw instanceof Date) return Number.isNaN(raw.getTime()) ? null : raw;
            const normalized = String(raw).replace(/-/g, '/');
            const d = new Date(normalized);
            if (!Number.isNaN(d.getTime())) return d;
            const fallback = new Date(raw);
            return Number.isNaN(fallback.getTime()) ? null : fallback;
        }

        function formatTimeForView(raw) {
            const d = parseToDate(raw);
            if (!d) return String(raw || '-');
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            const s = String(d.getSeconds()).padStart(2, '0');
            return y + '-' + m + '-' + day + ' ' + h + ':' + min + ':' + s;
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
