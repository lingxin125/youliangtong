<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>邮粮通 - 收购详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js"></script>
</head>
<body>
<div class="mobile-container">
    <div id="statusBar"></div>
    <div id="navBar"></div>

    <!-- 主内容区 -->
    <div class="flex-1 overflow-y-auto no-scrollbar p-4">

        <!-- 收购信息卡片 -->
        <div class="glass-panel rounded-2xl p-5">
            <!-- 品类标签 + 状态（右侧） -->
            <div class="flex items-center justify-between mb-3">
                <span id="categoryTag" class="text-[11px] bg-amber-50 text-amber-600 px-2.5 py-1 rounded-md font-medium">粮油</span>
                <span id="statusTag" class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded font-medium">进行中</span>
            </div>

            <!-- 需求标题 -->
            <h1 id="demandTitle" class="text-lg font-bold text-gray-800 mb-2 leading-relaxed">收购优质东北大米，2024年新米，含水量14%以下</h1>

            <!-- 描述（浅绿色容器） -->
            <div class="bg-green-50/60 rounded-lg p-3 mb-4">
                <p id="demandDesc" class="text-sm text-gray-700 leading-relaxed">粒粒饱满，口感香糯，产地直供，可提供质检报告</p>
            </div>

            <!-- 数量 & 单价 -->
            <div class="flex items-center py-4 border-y border-gray-100 mb-4">
                <div class="flex-1 text-center">
                    <div class="text-[10px] text-gray-400 mb-1">求购数量</div>
                    <div class="text-base font-semibold text-gray-800" style="font-family:Poppins;">
                        <span id="quantity">5000</span><span id="unit" class="text-sm ml-0.5">斤</span>
                    </div>
                </div>
                <div class="w-px h-10 bg-gray-200"></div>
                <div class="flex-1 text-center">
                    <div class="text-[10px] text-gray-400 mb-1">收购价格</div>
                    <div class="text-base font-semibold text-primary" style="font-family:Poppins;">
                        ¥<span id="price">2.8</span>/<span id="priceUnit">斤</span>
                    </div>
                </div>
            </div>

            <!-- 距离（左下） + 时间（右下） -->
            <div class="flex items-center justify-between text-[11px] text-gray-500">
                <div class="flex items-center gap-1">
                    <i class="fas fa-location-dot text-primary/60"></i>
                    <span id="distance" class="font-medium text-primary">距您 12.5km</span>
                </div>
                <span id="publishTime">2小时前</span>
            </div>
        </div>

        <!-- 收购商信息卡片 -->
        <div class="glass-panel rounded-2xl p-4 mt-4">
            <div class="text-xs font-medium text-gray-700 mb-3">收购商信息</div>
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-user text-primary text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="buyerName" class="text-sm font-medium text-gray-800">张老板</span>
                        <span class="text-[9px] bg-green-50 text-primary px-1.5 py-0.5 rounded">收购商</span>
                    </div>
                    <div id="buyerPhone" class="text-sm text-gray-600 font-medium" style="font-family:Poppins;">138****8888</div>
                </div>
            </div>
        </div>

    </div>

    <!-- 底部操作按钮 -->
    <div class="px-4 py-4 bg-gradient-to-t from-[#FFFBF0] via-[#FFFBF0] to-transparent border-t border-gray-100">
        <button id="contactBtn" class="w-full h-11 bg-primary text-white font-medium text-sm rounded-lg shadow-glow active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
            <i class="fas fa-phone text-sm"></i>
            <span>联系收购商</span>
        </button>
    </div>

    <!-- 联系方式弹层 (放在 mobile-container 内部) -->
    <div id="contactMask" class="absolute inset-0 bg-black/30 z-[70] hidden" onclick="closeContact()"></div>
    <div id="contactSheet" class="absolute left-0 right-0 bottom-0 z-[71] bg-white rounded-t-2xl p-4 hidden">
        <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mb-3"></div>
        <div class="text-sm font-semibold text-gray-800 mb-1" id="contactName">发布者</div>
        <div class="text-xs text-gray-500 mb-4">手机号：<span id="contactPhone" class="font-medium text-gray-700"></span></div>
        <div class="flex gap-2">
            <a id="callLink" href="javascript:void(0)" class="flex-1 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold text-center no-underline" style="text-decoration:none;">
                <i class="fas fa-phone mr-1"></i>拨打电话
            </a>
            <button class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold" onclick="copyContact()">复制号码</button>
        </div>
    </div>
</div>

<script>
document.getElementById('statusBar').innerHTML = renderStatusBar();

// 收购需求数据（与 farmer-market.html 保持一致）
var demandList = [
    { id: 'B1', category: '水果', content: '收购红富士苹果，果径80mm以上，连续采购15天', qty: 8000, unit: '斤', price: 3.4, location: '山东烟台', distanceKm: 2.8, ownerName: '泰丰收购站', ownerMobile: '13800138001', createdAt: new Date(Date.now() - 3 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'B2', category: '粮油', content: '求购新季玉米，水分14%以下，现场验货后当天结算', qty: 12000, unit: '斤', price: 1.6, location: '河南周口', distanceKm: 9.0, ownerName: '鑫源粮贸', ownerMobile: '13800138002', createdAt: new Date(Date.now() - 12 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'B3', category: '蔬菜', content: '大量收购有机西红柿，要求无破损，支持分批装车', qty: 6000, unit: '斤', price: 2.5, location: '河北保定', distanceKm: 11.5, ownerName: '绿鲜配送中心', ownerMobile: '13800138003', createdAt: new Date(Date.now() - 24 * 60 * 1000).toISOString(), status: 'active' }
];

// 品类颜色映射
function getCategoryColor(cat) {
    var colors = {
        '水果': { bg: 'bg-red-50', text: 'text-red-500' },
        '蔬菜': { bg: 'bg-green-50', text: 'text-green-600' },
        '粮油': { bg: 'bg-amber-50', text: 'text-amber-600' },
        '禽蛋': { bg: 'bg-violet-50', text: 'text-violet-500' },
        '肉类': { bg: 'bg-orange-50', text: 'text-orange-600' },
        '其他': { bg: 'bg-gray-100', text: 'text-gray-500' }
    };
    return colors[cat] || colors['其他'];
}

// 格式化时间
function formatTime(iso) {
    var d = new Date(iso || '');
    if (Number.isNaN(d.getTime())) return '-';
    var now = new Date();
    var diff = Math.floor((now - d) / 1000);

    if (diff < 60) return '刚刚';
    if (diff < 3600) return Math.floor(diff / 60) + '分钟前';
    if (diff < 86400) return Math.floor(diff / 3600) + '小时前';
    if (diff < 604800) return Math.floor(diff / 86400) + '天前';

    var m = d.getMonth() + 1;
    var day = d.getDate();
    return m + '月' + day + '日';
}

// 动态返回链接
var q = new URLSearchParams(window.location.search);
var sourcePage = q.get('source') || '';
var backLink = 'farmer-market.html';
if (sourcePage === 'home') backLink = 'farmer-home.html';
else if (sourcePage === 'manage') backLink = 'farmer-demand-manage.html';

// 重新渲染导航栏
document.getElementById('navBar').innerHTML = renderHeader('收购详情', backLink);

// 加载收购详情
function loadDemandDetail() {
    // 从URL获取ID
    var params = new URLSearchParams(window.location.search);
    var id = params.get('id');

    // 从数据列表中查找
    var demand = null;
    if (id) {
        demand = demandList.find(function(item) { return item.id === id; });
    }

    // 如果没有找到，使用默认数据（第一条）
    if (!demand) {
        demand = demandList[0];
    }

    // 应用品类颜色
    var color = getCategoryColor(demand.category);
    var tagEl = document.getElementById('categoryTag');
    tagEl.textContent = demand.category;
    tagEl.className = 'text-[11px] ' + color.bg + ' ' + color.text + ' px-2.5 py-1 rounded-md font-medium';

    // 填充数据
    document.getElementById('publishTime').textContent = formatTime(demand.createdAt);
    document.getElementById('demandTitle').textContent = demand.content || '';
    document.getElementById('demandDesc').textContent = demand.remark || demand.content || '';
    document.getElementById('quantity').textContent = demand.qty || 0;
    document.getElementById('unit').textContent = demand.unit || '斤';
    document.getElementById('price').textContent = demand.price || 0;
    document.getElementById('priceUnit').textContent = demand.unit || '斤';
    document.getElementById('buyerName').textContent = demand.ownerName || '未知';
    document.getElementById('buyerPhone').textContent = maskPhone(demand.ownerMobile) || '暂无电话';

    // 存储完整电话用于弹窗
    document.getElementById('contactBtn').dataset.phone = demand.ownerMobile || '';
    document.getElementById('contactBtn').dataset.name = demand.ownerName || '收购商';

    // 状态标签
    var statusTag = document.getElementById('statusTag');
    if (demand.status === 'active') {
        statusTag.textContent = '进行中';
        statusTag.className = 'text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded font-medium';
    } else {
        statusTag.textContent = '已下架';
        statusTag.className = 'text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-medium';
    }

    // 位置和距离
    document.getElementById('location').textContent = demand.location || '未知位置';
    document.getElementById('distance').textContent = '距您 ' + (demand.distanceKm || 0).toFixed(1) + 'km';
}

// 手机号脱敏
function maskPhone(phone) {
    if (!phone || phone.length !== 11) return phone;
    return phone.substring(0, 3) + '****' + phone.substring(7);
}

// 联系方式弹窗
var currentContactPhone = '';

function openContactModal() {
    var btn = document.getElementById('contactBtn');
    var phone = btn.dataset.phone;
    var name = btn.dataset.name;

    if (!phone) {
        alert('暂无联系方式');
        return;
    }

    currentContactPhone = phone;
    document.getElementById('contactName').textContent = name || '收购商';
    document.getElementById('contactPhone').textContent = maskPhone(phone);
    document.getElementById('callLink').setAttribute('href', 'tel:' + (phone || '').replace(/\*/g, ''));
    document.getElementById('contactMask').classList.remove('hidden');
    document.getElementById('contactSheet').classList.remove('hidden');
}

function closeContact() {
    document.getElementById('contactMask').classList.add('hidden');
    document.getElementById('contactSheet').classList.add('hidden');
}

function copyContact() {
    if (!currentContactPhone || currentContactPhone === '-') return;
    var text = currentContactPhone;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            showToast('号码已复制');
        }).catch(function() {
            showToast('复制失败，请手动复制');
        });
        return;
    }
    showToast('当前环境不支持自动复制');
}

function showToast(msg) {
    var tip = document.createElement('div');
    tip.className = 'fixed left-1/2 -translate-x-1/2 bottom-24 px-4 py-2 bg-black/85 text-white text-xs rounded-lg z-[74] whitespace-nowrap';
    tip.textContent = msg;
    document.body.appendChild(tip);
    setTimeout(function() {
        tip.remove();
    }, 2000);
}

// 绑定事件
document.getElementById('contactBtn').addEventListener('click', openContactModal);

// 初始化
loadDemandDetail();
</script>
</body>
</html>
