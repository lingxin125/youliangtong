<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>邮粮通 - 收款记录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js?v=2"></script>
    <style>
        /* ========== 基础样式 ========== */
        .amount-received { color: #11A64A; }
        .amount-pending { color: #D97706; }
        .amount-cancelled { color: #9CA3AF; text-decoration: line-through; }

        .status-success { background: #DCFCE7; color: #166534; }
        .status-pending { background: #FEF3C7; color: #92400E; }
        .status-cancelled { background: #F3F4F6; color: #6B7280; }

        /* ========== 筛选面板 ========== */
        .filter-overlay {
            position: absolute; inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .filter-overlay.show { opacity: 1; pointer-events: auto; }

        .filter-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            z-index: 101;
            background: white;
            border-radius: 16px 16px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 70%;
            display: flex; flex-direction: column;
        }
        .filter-sheet.show { transform: translateY(0); }

        .filter-option {
            font-size: 12px; padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            background: white; color: #4B5563;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .filter-option.active {
            background: #F0FDF4;
            border-color: #11A64A;
            color: #11A64A;
            font-weight: 500;
        }

        .date-input {
            flex: 1; height: 36px; padding: 0 12px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 12px; color: #374151;
            background: white;
        }

        /* ========== 日期分组 ========== */
        .date-group-card {
            background: linear-gradient(145deg, rgba(17, 166, 74, 0.06) 0%, #FFFFFF 100%) !important;
            border: 1px solid rgba(17, 166, 74, 0.12);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
        }

        .record-list {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0;
        }
        .record-list.expanded {
            max-height: 2000px;
        }

        .expand-icon {
            transition: transform 0.2s ease;
        }

        /* ========== 记录项 ========== */
        .record-item {
            background: white;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        .record-item + .record-item {
            margin-top: 8px;
        }

        .method-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0;
        }
        .method-industry { background: #E0F2FE; color: #0284C7; }
        .method-guarantee { background: #F3E8FF; color: #9333EA; }

        /* ========== Toast提示 ========== */
        .toast-tip {
            position: absolute; left: 16px; right: 16px; bottom: 88px;
            padding: 11px 14px;
            background: rgba(17, 24, 39, 0.9);
            border-radius: 11px;
            color: #fff; font-size: 12px; line-height: 1.45;
            z-index: 70;
            opacity: 0; pointer-events: none;
            transform: translateY(8px);
            transition: all 0.2s ease;
        }
        .toast-tip.show { opacity: 1; transform: translateY(0); }

        .filter-group-title {
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; font-weight: 500;
            color: #374151; margin-bottom: 10px;
        }
        .filter-group-title i { color: #9CA3AF; font-size: 14px; }

        .filter-content { flex: 1; overflow-y: auto; padding: 16px; }
    </style>
</head>
<body>
<div class="mobile-container" style="position: relative; overflow: hidden;">
    <div id="statusBar"></div>
    <div id="navBar"></div>

    <!-- 统计栏 -->
    <div class="px-4 mb-3 shrink-0 flex items-center justify-between">
        <div class="text-[13px] text-gray-500">
            共 <span class="text-primary font-semibold" id="recordCount">0</span> 条收款
        </div>
        <button id="filterBtn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 active:bg-gray-100" onclick="FilterPanel.open()">
            <i class="fas fa-filter text-gray-600 text-xs"></i>
            <span class="text-[12px] text-gray-600">筛选</span>
        </button>
    </div>

    <!-- 筛选结果汇总（仅筛选时显示） -->
    <div id="filterResult" class="px-4 mb-3 shrink-0 hidden">
        <div class="glass-card rounded-2xl p-4 bg-gradient-to-r from-green-50 to-white border border-green-100">
            <div class="text-[14px] font-semibold text-gray-800 mb-3">筛选结果</div>
            <div class="flex items-center">
                <div class="flex-1 text-center">
                    <div class="text-[12px] text-gray-500 mb-0.5">收入总额</div>
                    <div class="text-[18px] font-bold text-gray-900" style="font-family:Poppins;">
                        ¥<span id="filterTotalAmount">0.00</span>
                    </div>
                </div>
                <div class="w-px h-10 bg-gray-200"></div>
                <div class="flex-1 text-center">
                    <div class="text-[12px] text-gray-500 mb-0.5">交易笔数</div>
                    <div class="text-[18px] font-bold text-gray-900">
                        <span id="filterRecordCount">0</span>笔
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 空状态 -->
    <div id="emptyState" class="px-4 pt-8 hidden">
        <div class="text-center">
            <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-wallet text-gray-300 text-2xl"></i>
            </div>
            <div class="text-[15px] font-medium text-gray-600">暂无收款记录</div>
            <div class="text-[12px] text-gray-400 mt-2">收购商完成支付后会自动展示在这里</div>
        </div>
    </div>

    <!-- 收款列表 -->
    <div id="recordList" class="flex-1 overflow-y-auto no-scrollbar px-4 space-y-3" style="padding-bottom:80px;"></div>

    <!-- Toast提示 -->
    <div id="toastTip" class="toast-tip"></div>

    <!-- 底部导航栏 -->
    <div id="tabBar"></div>

    <!-- 筛选弹窗 -->
    <div id="filterOverlay" class="filter-overlay" onclick="FilterPanel.close()"></div>
    <div id="filterSheet" class="filter-sheet">
        <div class="flex justify-center pt-2 pb-1">
            <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
        </div>
        <div class="px-4 py-3 border-b border-gray-100 flex-shrink-0">
            <div class="flex items-center justify-between">
                <h3 class="text-[15px] font-semibold text-gray-800">筛选收款记录</h3>
                <button class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-gray-100" onclick="FilterPanel.close()">
                    <i class="fas fa-times text-gray-400 text-sm"></i>
                </button>
            </div>
        </div>
        <div class="filter-content space-y-5">
            <!-- 时间范围 -->
            <div>
                <div class="filter-group-title">
                    <i class="far fa-calendar-alt"></i><span>时间范围</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-option active" data-type="time" data-value="all">全部</button>
                    <button class="filter-option" data-type="time" data-value="today">今天</button>
                    <button class="filter-option" data-type="time" data-value="week">近7天</button>
                    <button class="filter-option" data-type="time" data-value="month">近30天</button>
                    <button class="filter-option" data-type="time" data-value="custom">自定义日期</button>
                </div>
                <div id="customDateRange" class="mt-3 hidden">
                    <div class="flex items-center gap-2">
                        <input type="date" id="startDate" class="date-input">
                        <span class="text-gray-400">至</span>
                        <input type="date" id="endDate" class="date-input">
                    </div>
                </div>
            </div>
            <!-- 支付方式 -->
            <div>
                <div class="filter-group-title">
                    <i class="fas fa-credit-card"></i><span>支付方式</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-option active" data-type="method" data-value="all">全部</button>
                    <button class="filter-option" data-type="method" data-value="industry">行业支付</button>
                    <button class="filter-option" data-type="method" data-value="guarantee">订单付</button>
                </div>
            </div>
        </div>
        <div class="px-4 py-3 border-t border-gray-100 flex gap-3 flex-shrink-0">
            <button class="flex-1 h-10 rounded-2xl border border-gray-200 text-[13px] font-medium text-gray-600 bg-white" onclick="FilterPanel.reset()">重置</button>
            <button class="flex-1 h-10 rounded-2xl text-[13px] font-medium text-white bg-primary" onclick="FilterPanel.confirm()">确定</button>
        </div>
    </div>
</div>

<script>
// ==================== 数据服务层 ====================
const RecordService = {
    mockStore: window.BuyerMockStore || null,
    farmerName: '李大姐',

    getRecords() {
        if (this.mockStore?.getOrders) {
            const orders = this.mockStore.getOrders();
            // 筛选出当前农户的收款记录（作为收款方）
            return orders.filter(order => order.payeeName === this.farmerName);
        }
        return this.getFallbackRecords();
    },

    getFallbackRecords() {
        return [
            {
                id: 'SL20260212142210',
                payerName: '张老板',
                payerMobile: '139****6666',
                payeeName: '李大姐',
                summary: '东北大米 x 1000斤',
                amount: 3200,
                status: 'success',
                payMethod: 'guarantee',
                createdAt: '2026-02-12T14:22:10+08:00',
                paidAt: '2026-02-12T14:23:08+08:00',
                items: [{ name: '东北大米', qty: 1000, unit: '斤', price: 3.2, subtotal: 3200 }]
            },
            {
                id: 'SL20260211103322',
                payerName: '李经理',
                payerMobile: '138****5566',
                payeeName: '李大姐',
                summary: '有机西红柿 x 500斤',
                amount: 1450,
                status: 'success',
                payMethod: 'industry',
                createdAt: '2026-02-11T10:33:22+08:00',
                paidAt: '2026-02-11T10:34:00+08:00',
                items: [{ name: '有机西红柿', qty: 500, unit: '斤', price: 2.9, subtotal: 1450 }]
            },
            {
                id: 'SL20260210091530',
                payerName: '王收购',
                payerMobile: '137****7788',
                payeeName: '李大姐',
                summary: '苹果 x 200斤',
                amount: 1200,
                status: 'success',
                payMethod: 'guarantee',
                createdAt: '2026-02-10T09:15:30+08:00',
                items: [{ name: '苹果', qty: 200, unit: '斤', price: 6, subtotal: 1200 }]
            },
            {
                id: 'SL20260209160000',
                payerName: '赵老板',
                payerMobile: '136****9999',
                payeeName: '李大姐',
                summary: '黄瓜 x 300斤',
                amount: 900,
                status: 'success',
                payMethod: 'industry',
                createdAt: '2026-02-09T16:00:00+08:00',
                items: [{ name: '黄瓜', qty: 300, unit: '斤', price: 3, subtotal: 900 }]
            }
        ];
    },

    findById(recordId) {
        return this.getRecords().find(r => r.id === recordId);
    }
};

// ==================== 筛选服务层 ====================
const FilterService = {
    state: {
        timeRange: 'all',
        startDate: null,
        endDate: null,
        payMethods: []
    },

    isActive() {
        return this.state.timeRange !== 'all' ||
               this.state.payMethods.length > 0;
    },

    setTimeRange(value) {
        this.state.timeRange = value;
    },

    setMethod(value) {
        this.state.payMethods = value === 'all' ? [] : [value];
    },

    setCustomDates(start, end) {
        this.state.startDate = start;
        this.state.endDate = end;
    },

    reset() {
        this.state = {
            timeRange: 'all',
            startDate: null,
            endDate: null,
            payMethods: []
        };
    },

    apply(records) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        return records.filter(record => {
            const recordDate = new Date(record.createdAt);
            const recordDay = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());

            // 时间筛选
            let timeMatch = true;
            const { timeRange, startDate, endDate } = this.state;

            if (timeRange === 'today') {
                timeMatch = recordDay.getTime() === today.getTime();
            } else if (timeRange === 'week') {
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                timeMatch = recordDay >= weekAgo;
            } else if (timeRange === 'month') {
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                timeMatch = recordDay >= monthAgo;
            } else if (timeRange === 'custom' && startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                timeMatch = recordDay >= start && recordDay <= end;
            }

            // 支付方式筛选
            let methodMatch = this.state.payMethods.length === 0 ||
                              this.state.payMethods.includes(record.payMethod) ||
                              (this.state.payMethods.includes('') && record.payMethod === '');

            return timeMatch && methodMatch;
        }).sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    }
};

// ==================== 分组服务层 ====================
const GroupService = {
    expanded: {},

    group(records) {
        const groups = {};

        records.forEach(record => {
            const date = new Date(record.createdAt);
            const dateKey = this.formatDateKey(date);
            const displayDate = this.formatDisplayDate(date);

            if (!groups[dateKey]) {
                groups[dateKey] = {
                    dateKey,
                    displayDate,
                    records: [],
                    totalAmount: 0
                };
            }
            groups[dateKey].records.push(record);
            groups[dateKey].totalAmount += record.amount;
        });

        return Object.values(groups).sort((a, b) => b.dateKey.localeCompare(a.dateKey));
    },

    formatDateKey(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    },

    formatDisplayDate(date) {
        return `${date.getFullYear()}年${String(date.getMonth() + 1).padStart(2, '0')}月${String(date.getDate()).padStart(2, '0')}日`;
    },

    isExpanded(dateKey) {
        // 默认收起所有分组
        return this.expanded[dateKey] === true;
    },

    toggle(dateKey) {
        this.expanded[dateKey] = !this.isExpanded(dateKey);
        return this.expanded[dateKey];
    }
};

// ==================== 格式化服务层 ====================
const FormatService = {
    // 智能时间格式：今天/昨天/前天/MM-DD/YYYY-MM-DD HH:MM:SS
    smartTime(iso) {
        const now = new Date();
        const date = new Date(iso);
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        const diffYears = now.getFullYear() - date.getFullYear();

        const h = String(date.getHours()).padStart(2, '0');
        const m = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        const mo = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const y = date.getFullYear();

        if (diffDays === 0) return `${h}:${m}:${s}`;
        if (diffDays === 1) return `昨天 ${h}:${m}:${s}`;
        if (diffDays === 2) return `前天 ${h}:${m}:${s}`;
        if (diffYears === 0) return `${mo}-${d} ${h}:${m}:${s}`;
        return `${y}-${mo}-${d} ${h}:${m}:${s}`;
    },

    amount(value) {
        return value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
};

// ==================== 状态映射 ====================
const StatusMap = {
    success: { class: 'status-success', text: '已收款', amountClass: 'amount-received' }
};

const MethodMap = {
    industry: { icon: 'fa-building-columns', text: '行业支付', class: 'method-industry' },
    guarantee: { icon: 'fa-file-invoice-dollar', text: '订单付', class: 'method-guarantee' },
    '': { icon: 'fa-clock', text: '未支付', class: '' }
};

// ==================== UI 渲染层 ====================
const RenderService = {
    renderRecordItem(record, isLast) {
        const status = StatusMap.success;
        const method = MethodMap[record.payMethod] || MethodMap[''];
        const timeStr = FormatService.smartTime(record.createdAt);

        const methodHtml = method.class
            ? `<div class="method-icon ${method.class}"><i class="fas ${method.icon}"></i></div>`
            : `<div class="method-icon" style="background:#F3F4F6;color:#9CA3AF;"><i class="fas ${method.icon}"></i></div>`;

        const borderClass = isLast ? '' : 'border-b border-gray-100';

        return `
            <div class="p-3 ${borderClass} cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors" onclick="Actions.goDetail('${record.id}')">
                <div class="flex items-center gap-3">
                    ${methodHtml}
                    <div class="flex-1 min-w-0">
                        <div class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100">
                            <span class="text-[12px] font-semibold text-gray-700">${timeStr}</span>
                        </div>
                        <div class="text-[14px] text-gray-500 mt-1">来自 ${record.payerName}</div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-[18px] font-bold ${status.amountClass}" style="font-family:Poppins;">+¥${FormatService.amount(record.amount)}</span>
                        <span class="status-tag ${status.class} mt-1 text-[11px] px-2 py-0.5 rounded-full font-medium">${status.text}</span>
                    </div>
                </div>
            </div>
        `;
    },

    renderRecordItemsWithDividers(records) {
        return records.map((r, index) => this.renderRecordItem(r, index === records.length - 1)).join('');
    },

    renderDateGroup(group, isExpanded) {
        const arrowIcon = isExpanded ? 'fa-chevron-up' : 'fa-chevron-down';

        return `
            <div class="date-group-card" id="group-${group.dateKey}">
                <div class="px-4 py-3 cursor-pointer" onclick="Actions.toggleGroup('${group.dateKey}')">
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col gap-1">
                            <span class="text-[15px] font-semibold text-gray-800">${group.displayDate}</span>
                            <div class="flex items-center gap-1 text-[13px] text-gray-600">
                                <span>收款：</span>
                                <span class="font-bold text-gray-900" style="font-family:Poppins;">${FormatService.amount(group.totalAmount)}</span>
                                <span>元，共</span>
                                <span class="font-bold text-gray-900">${group.records.length}</span>
                                <span>笔</span>
                            </div>
                        </div>
                        <i id="icon-${group.dateKey}" class="fas ${arrowIcon} text-gray-400 text-sm expand-icon"></i>
                    </div>
                </div>
                <div id="list-${group.dateKey}" class="record-list ${isExpanded ? 'expanded' : ''}">
                    <div class="bg-white px-3 pb-3 rounded-b-xl">
                        ${this.renderRecordItemsWithDividers(group.records)}
                    </div>
                </div>
            </div>
        `;
    },

    renderEmpty() {
        document.getElementById('recordList').innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('filterResult').classList.add('hidden');
        document.getElementById('recordCount').textContent = '0';
    },

    renderList(groups) {
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('filterResult').classList.add('hidden');

        const totalCount = groups.reduce((sum, g) => sum + g.records.length, 0);
        document.getElementById('recordCount').textContent = totalCount;

        const html = groups.map((group) => {
            const isExpanded = GroupService.isExpanded(group.dateKey);
            return this.renderDateGroup(group, isExpanded);
        }).join('');

        document.getElementById('recordList').innerHTML = html;
    },

    renderFlatList(records) {
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('filterResult').classList.remove('hidden');

        const totalCount = records.length;
        const totalAmount = records.reduce((sum, r) => sum + r.amount, 0);

        document.getElementById('recordCount').textContent = totalCount;
        document.getElementById('filterTotalAmount').textContent = FormatService.amount(totalAmount);
        document.getElementById('filterRecordCount').textContent = totalCount;

        // 平铺展示也使用统一卡片+分割线样式
        document.getElementById('recordList').innerHTML = `
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="bg-white px-3 pb-3 rounded-b-xl">
                    ${this.renderRecordItemsWithDividers(records)}
                </div>
            </div>
        `;
    }
};

// ==================== 筛选面板控制 ====================
const FilterPanel = {
    open() {
        document.getElementById('filterOverlay').classList.add('show');
        document.getElementById('filterSheet').classList.add('show');
    },

    close() {
        document.getElementById('filterOverlay').classList.remove('show');
        document.getElementById('filterSheet').classList.remove('show');
    },

    reset() {
        FilterService.reset();
        document.querySelectorAll('.filter-option').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === 'all');
        });
        document.getElementById('customDateRange').classList.add('hidden');
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
    },

    confirm() {
        if (FilterService.state.timeRange === 'custom') {
            FilterService.setCustomDates(
                document.getElementById('startDate').value,
                document.getElementById('endDate').value
            );
        }
        this.close();
        App.refresh();
    },

    init() {
        // 筛选按钮点击事件委托
        document.querySelectorAll('.filter-option').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = e.target.dataset.type;
                const value = e.target.dataset.value;

                // 同组其他按钮取消激活
                document.querySelectorAll(`[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                // 更新筛选状态
                if (type === 'time') {
                    FilterService.setTimeRange(value);
                    document.getElementById('customDateRange').classList.toggle('hidden', value !== 'custom');
                } else if (type === 'method') {
                    FilterService.setMethod(value);
                }
            });
        });
    }
};

// ==================== 用户操作 ====================
const Actions = {
    toggleGroup(dateKey) {
        const isExpanded = GroupService.toggle(dateKey);
        const listEl = document.getElementById(`list-${dateKey}`);
        const iconEl = document.getElementById(`icon-${dateKey}`);

        listEl.classList.toggle('expanded', isExpanded);
        iconEl.className = `fas fa-chevron-${isExpanded ? 'up' : 'down'} text-gray-400 text-sm expand-icon`;
    },

    goDetail(recordId) {
        const record = RecordService.findById(recordId);
        if (!record) return;

        const params = new URLSearchParams({
            source: 'records',
            status: record.status,
            orderNo: record.id,
            amount: record.amount.toFixed(2),
            payerName: record.payerName,
            payerMobile: record.payerMobile || '',
            summary: record.summary || '',
            createdAt: record.createdAt,
            payMethod: record.payMethod || '',
            paidAt: record.paidAt || '',
            items: JSON.stringify(record.items || [])
        });

        window.location.href = 'farmer-collection-detail.html?' + params.toString();
    }
};

// ==================== 应用主控 ====================
const App = {
    init() {
        // 读取来源参数
        const urlParams = new URLSearchParams(window.location.search);
        const sourcePage = urlParams.get('source') || 'my';
        const backLink = sourcePage === 'home' ? 'farmer-home.html' : 'farmer-my.html';

        // 初始化UI组件
        document.getElementById('statusBar').innerHTML = renderStatusBar();
        document.getElementById('navBar').innerHTML = renderHeader('收款记录', backLink);
        document.getElementById('tabBar').innerHTML = renderFarmerTabBar('mine');

        // 初始化筛选面板
        FilterPanel.init();

        // 首次渲染
        this.refresh();
    },

    refresh() {
        // 获取并筛选记录
        const records = RecordService.getRecords();
        const filtered = FilterService.apply(records);

        // 空状态处理
        if (filtered.length === 0) {
            RenderService.renderEmpty();
            return;
        }

        // 有筛选条件时平铺展示，无筛选时按天分组展示
        if (FilterService.isActive()) {
            RenderService.renderFlatList(filtered);
        } else {
            const groups = GroupService.group(filtered);
            RenderService.renderList(groups);
        }
    },

    showToast(msg) {
        const tip = document.getElementById('toastTip');
        tip.textContent = msg;
        tip.classList.add('show');
        clearTimeout(this._toastTimer);
        this._toastTimer = setTimeout(() => tip.classList.remove('show'), 1800);
    }
};

// 启动应用
App.init();
</script>
</body>
</html>
