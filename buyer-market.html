<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>邮粮通 - 市场</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js"></script>
</head>
<body>
<div class="mobile-container">
    <div id="statusBar"></div>
    <div id="navBar"></div>

    <!-- 顶部：搜索 + 筛选 -->
    <div class="px-4 mt-2 mb-3 shrink-0">
        <div class="flex gap-2 items-center">
            <div class="glass-card rounded-xl px-3.5 py-2.5 flex items-center gap-2.5 flex-1">
                <i class="fas fa-search text-gray-400 text-sm"></i>
                <input id="searchInput" type="text" placeholder="搜索品类、需求关键词..." class="flex-1 bg-transparent text-sm text-gray-700 outline-none placeholder-gray-400">
            </div>
            <button type="button" id="filterBtn" class="w-10 h-10 rounded-xl bg-white/90 border border-gray-200 text-gray-500 flex items-center justify-center shadow-sm relative" onclick="openFilter()" aria-label="打开筛选">
                <i class="fas fa-filter text-[13px]"></i>
                <span id="filterDot" class="hidden absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
            </button>
        </div>
    </div>

    <!-- 工具入口：排序下拉 + 筛选标签 -->
    <div class="px-4 mb-3 shrink-0">
        <div class="flex items-center gap-2">
            <!-- 左侧：排序 + 筛选 -->
            <div class="flex items-center gap-2 flex-1">
                <!-- 排序下拉 -->
                <div class="relative shrink-0">
                    <button id="sortDropdownBtn" type="button" class="text-[10px] text-gray-700 font-medium bg-gray-50 border border-gray-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1.5" onclick="toggleSortDropdown()">
                        <i class="fas fa-sort-amount-down text-[10px] text-gray-400"></i>
                        <span id="sortLabel">最新发布</span>
                        <i class="fas fa-chevron-down text-[8px] text-gray-400 transition-transform" id="sortArrow"></i>
                    </button>
                    <!-- 排序下拉菜单 -->
                    <div id="sortDropdown" class="hidden absolute top-full left-0 mt-1.5 bg-white rounded-xl shadow-lg border border-gray-100 py-1 min-w-[120px] z-50">
                        <button type="button" class="w-full text-left text-[11px] px-3 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setSortOption('latest')">
                            <span class="w-4 text-center"><i class="fas fa-check text-primary text-[10px] opacity-0" id="check-latest"></i></span>
                            最新发布
                        </button>
                        <button type="button" class="w-full text-left text-[11px] px-3 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setSortOption('oldest')">
                            <span class="w-4 text-center"><i class="fas fa-check text-primary text-[10px] opacity-0" id="check-oldest"></i></span>
                            最晚发布
                        </button>
                        <button type="button" class="w-full text-left text-[11px] px-3 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setSortOption('nearest')">
                            <span class="w-4 text-center"><i class="fas fa-check text-primary text-[10px] opacity-0" id="check-nearest"></i></span>
                            距离最近
                        </button>
                        <button type="button" class="w-full text-left text-[11px] px-3 py-2 hover:bg-gray-50 flex items-center gap-2" onclick="setSortOption('farthest')">
                            <span class="w-4 text-center"><i class="fas fa-check text-primary text-[10px] opacity-0" id="check-farthest"></i></span>
                            距离最远
                        </button>
                    </div>
                </div>

                <!-- 我关注的 -->
                <button id="focusOnlyBtn" type="button" class="text-[10px] text-gray-500 font-medium bg-gray-50 border border-gray-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1" onclick="toggleFocusOnly()">
                    <span>我关注的</span>
                    <i id="focusCloseIcon" class="fas fa-times text-[9px] hidden"></i>
                </button>
            </div>

            <!-- 关键词标签 - 固定右侧 -->
            <button type="button" class="text-[10px] text-amber-700 font-medium bg-amber-50 border border-amber-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1 shrink-0" onclick="location.href='buyer-keywords.html?source=market'">
                <i class="fas fa-tag text-[9px] text-amber-600"></i>
                关键词设置
                <span id="keywordCount" class="text-[9px]"></span>
            </button>
        </div>
    </div>

    <!-- 列表 -->
    <div id="demandList" class="flex-1 overflow-y-auto no-scrollbar px-4 space-y-3" style="padding-bottom:120px;"></div>

    <!-- 悬浮发布按钮 -->
    <a href="buyer-publish.html" class="absolute right-5 bottom-24 w-12 h-12 rounded-full bg-green-50 text-primary flex items-center justify-center shadow-[0_4px_20px_rgba(0,0,0,0.15)] border border-green-200 no-underline z-[60] active:scale-95 transition-transform" style="text-decoration:none;" aria-label="发布求购">
        <i class="fas fa-bullhorn text-xl"></i>
    </a>

    <div id="tabBar"></div>

    <!-- 筛选抽屉 -->
    <div id="filterMask" class="absolute inset-0 bg-black/30 z-[72] hidden" onclick="closeFilter()"></div>
    <div id="filterSheet" class="absolute left-0 right-0 bottom-0 z-[73] bg-white rounded-t-2xl p-4 hidden">
        <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mb-3"></div>
        <div class="text-sm font-semibold text-gray-800 mb-3">筛选条件</div>

        <div class="space-y-4 max-h-[46vh] overflow-y-auto no-scrollbar pb-2">
            <div>
                <div class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                    <i class="far fa-clock text-gray-400"></i>
                    发布时间
                </div>
                <div id="timeGroup" class="flex flex-wrap gap-2"></div>
                <div id="customDateBox" class="hidden mt-3 p-3 bg-gray-50 rounded-xl">
                    <div class="text-[11px] text-gray-500 mb-2">选择日期范围</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <div class="text-[10px] text-gray-400 mb-1">开始日期</div>
                            <input type="date" id="customDateStart" class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-primary bg-white" onchange="onCustomDateChange()">
                        </div>
                        <div class="text-gray-300 mt-4">—</div>
                        <div class="flex-1">
                            <div class="text-[10px] text-gray-400 mb-1">结束日期</div>
                            <input type="date" id="customDateEnd" class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-primary bg-white" onchange="onCustomDateChange()">
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                    <i class="fas fa-th-large text-gray-400"></i>
                    品类
                </div>
                <div id="categoryGroup" class="grid grid-cols-4 gap-2"></div>
            </div>
            <div>
                <div class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                    <i class="fas fa-map-marker-alt text-gray-400"></i>
                    距离
                </div>
                <div id="distanceGroup" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div class="flex gap-2 pt-2">
            <button type="button" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold" onclick="resetFilter()">重置</button>
            <button type="button" class="flex-1 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold" onclick="applyFilter()">确认</button>
        </div>
    </div>

    <!-- 联系方式弹层 -->
    <div id="contactMask" class="absolute inset-0 bg-black/30 z-[70] hidden" onclick="closeContact()"></div>
    <div id="contactSheet" class="absolute left-0 right-0 bottom-0 z-[71] bg-white rounded-t-2xl p-4 hidden">
        <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mb-3"></div>
        <div class="text-sm font-semibold text-gray-800 mb-1" id="contactName">发布者</div>
        <div class="text-xs text-gray-500 mb-4">手机号：<span id="contactPhone" class="font-medium text-gray-700"></span></div>
        <div class="flex gap-2">
            <a id="callLink" href="javascript:void(0)" class="flex-1 py-2.5 bg-primary text-white rounded-xl text-sm font-semibold text-center no-underline" style="text-decoration:none;">
                <i class="fas fa-phone mr-1"></i>拨打电话
            </a>
            <button class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl text-sm font-semibold" onclick="copyContact()">复制号码</button>
        </div>
    </div>

    <div id="toastTip" class="absolute left-4 right-4 bottom-[84px] px-3.5 py-2.5 bg-black/85 text-white text-xs rounded-lg opacity-0 pointer-events-none transition-all duration-200 z-[74]"></div>
</div>

<script>
document.getElementById('statusBar').innerHTML = renderStatusBar();
document.getElementById('navBar').innerHTML = renderHeader('市场');
document.getElementById('tabBar').innerHTML = renderBuyerTabBar('market');

var demandStore = window.DemandMockStore || null;
var KEYWORD_STORAGE_KEY = 'ylt_keywords_buyer_v1';

var state = {
    sort: 'latest',
    activeTab: 'latest', // 'latest' | 'oldest' | 'nearest' | 'farthest'
    timeRange: 'all',
    customDateStart: '',
    customDateEnd: '',
    category: '全部',
    maxDistance: 'all',
    keyword: '',
    onlyFocus: false
};

var draftFilter = null;
var currentContactPhone = '';
var myKeywords = loadKeywords();

var fallbackList = [
    // 刚刚（0-1分钟内）
    { id: 'F1', category: '水果', content: '出售红富士苹果，果径80mm以上，自家果园直发', qty: 5000, unit: '斤', price: 2.6, location: '山东烟台', distanceKm: 3.2, ownerName: '李大姐果园', ownerMobile: '138****1234', createdAt: new Date(Date.now() - 30 * 1000).toISOString(), status: 'active' },
    { id: 'F2', category: '蔬菜', content: '新鲜采摘黄瓜，长度25cm左右，现摘现发', qty: 2000, unit: '斤', price: 1.8, location: '山东潍坊', distanceKm: 2.1, ownerName: '张大哥菜棚', ownerMobile: '136****8888', createdAt: new Date(Date.now() - 45 * 1000).toISOString(), status: 'active' },
    // 几分钟前（5-50分钟）
    { id: 'F3', category: '粮油', content: '出售优质小麦，含水量13%以内，可提供质检', qty: 20000, unit: '斤', price: 1.9, location: '河南周口', distanceKm: 7.5, ownerName: '王建国家庭农场', ownerMobile: '139****5678', createdAt: new Date(Date.now() - 5 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F4', category: '蔬菜', content: '自种有机西红柿，今天可采摘，支持当天装车', qty: 3000, unit: '斤', price: 2.3, location: '河北保定', distanceKm: 12.0, ownerName: '老周蔬菜棚', ownerMobile: '137****6002', createdAt: new Date(Date.now() - 18 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F5', category: '禽蛋', content: '散养土鸡蛋，蛋黄饱满，50枚/箱，100箱起批', qty: 5000, unit: '枚', price: 1.2, location: '江苏南通', distanceKm: 8.3, ownerName: '赵姐养殖场', ownerMobile: '150****2345', createdAt: new Date(Date.now() - 32 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F6', category: '水果', content: '巨峰葡萄自然成熟，甜度18+，5斤起售', qty: 3000, unit: '斤', price: 4.5, location: '浙江金华', distanceKm: 15.6, ownerName: '刘庄主葡萄园', ownerMobile: '139****7777', createdAt: new Date(Date.now() - 48 * 60 * 1000).toISOString(), status: 'active' },
    // 几小时前（1-12小时）
    { id: 'F7', category: '肉类', content: '散养黑猪肉，当天宰杀，排骨五花肉齐全', qty: 800, unit: '斤', price: 28.0, location: '安徽阜阳', distanceKm: 22.0, ownerName: '老李养猪场', ownerMobile: '138****6666', createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F8', category: '其他', content: '鲜活草鱼，规格2-3斤/条，塘口直发', qty: 1500, unit: '斤', price: 8.5, location: '湖北荆州', distanceKm: 35.0, ownerName: '周师傅鱼塘', ownerMobile: '137****5555', createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F9', category: '粮油', content: '新榨花生油，纯物理压榨，5L/桶', qty: 200, unit: '桶', price: 85.0, location: '山东临沂', distanceKm: 18.5, ownerName: '孙家油坊', ownerMobile: '136****4444', createdAt: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F10', category: '蔬菜', content: '紫皮大蒜头，蒜头饱满，适合储存', qty: 5000, unit: '斤', price: 3.2, location: '河南商丘', distanceKm: 28.0, ownerName: '大蒜种植合作社', ownerMobile: '135****3333', createdAt: new Date(Date.now() - 8 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F11', category: '水果', content: '黄心猕猴桃，单果90g+，甜度高', qty: 2500, unit: '斤', price: 5.8, location: '陕西周至', distanceKm: 42.0, ownerName: '杨氏果园', ownerMobile: '134****2222', createdAt: new Date(Date.now() - 11 * 60 * 60 * 1000).toISOString(), status: 'active' },
    // 十几个小时前
    { id: 'F12', category: '禽蛋', content: '老鸭蛋，腌制咸鸭蛋原料，个大壳青', qty: 3000, unit: '枚', price: 2.0, location: '江西九江', distanceKm: 55.0, ownerName: '鸭蛋批发部', ownerMobile: '133****1111', createdAt: new Date(Date.now() - 16 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F13', category: '粮油', content: '糯玉米棒子，甜糯可口，适合煮食', qty: 8000, unit: '斤', price: 1.5, location: '河北张家口', distanceKm: 62.0, ownerName: '王大爷农场', ownerMobile: '132****0000', createdAt: new Date(Date.now() - 20 * 60 * 60 * 1000).toISOString(), status: 'active' },
    // 几天前（1-5天）
    { id: 'F14', category: '肉类', content: '山羊羊肉，放养草饲，肉质鲜嫩', qty: 600, unit: '斤', price: 35.0, location: '内蒙古赤峰', distanceKm: 120.0, ownerName: '草原牧业', ownerMobile: '131****9999', createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F15', category: '水果', content: '冰糖心苹果，甜脆多汁，糖心率高', qty: 10000, unit: '斤', price: 3.8, location: '新疆阿克苏', distanceKm: 350.0, ownerName: '疆果直发', ownerMobile: '130****8888', createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F16', category: '其他', content: '干海带丝，无沙免洗，泡发率高', qty: 500, unit: '斤', price: 12.0, location: '福建宁德', distanceKm: 180.0, ownerName: '海产品批发', ownerMobile: '129****7777', createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F17', category: '蔬菜', content: '东北黑木耳，肉厚朵大，泡发率高', qty: 300, unit: '斤', price: 45.0, location: '黑龙江牡丹江', distanceKm: 280.0, ownerName: '山珍特产店', ownerMobile: '128****6666', createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(), status: 'active' },
    { id: 'F18', category: '其他', content: '干香菇，香味浓郁，无硫熏', qty: 400, unit: '斤', price: 38.0, location: '湖北随州', distanceKm: 95.0, ownerName: '香菇种植基地', ownerMobile: '127****5555', createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), status: 'active' }
];

var FILTER_META = {
    timeRange: [
        { value: 'all', label: '全部时间' },
        { value: '1h', label: '1小时内' },
        { value: 'today', label: '今天' },
        { value: '3d', label: '3天内' },
        { value: 'custom', label: '自定义' }
    ],
    category: ['全部', '水果', '蔬菜', '粮油', '禽蛋', '肉类', '其他'],
    maxDistance: [
        { value: 'all', label: '全部距离' },
        { value: '5', label: '5km内' },
        { value: '10', label: '10km内' },
        { value: '20', label: '20km内' }
    ]
};

document.getElementById('searchInput').addEventListener('input', function(e) {
    state.keyword = e.target.value.trim();
    renderList();
});

function loadKeywords() {
    try {
        var raw = window.localStorage.getItem(KEYWORD_STORAGE_KEY);
        if (!raw) return [];
        var parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(function(k) { return String(k || '').trim(); }).filter(Boolean);
    } catch (err) {
        return [];
    }
}

function updateKeywordCount() {
    var count = myKeywords.length;
    var badge = document.getElementById('keywordCount');
    if (!badge) return;
    if (count > 0) {
        badge.textContent = count;
        badge.className = 'ml-0.5 w-3.5 h-3.5 rounded-full bg-red-500 text-white text-[8px] flex items-center justify-center';
    } else {
        badge.textContent = '';
        badge.className = 'text-[9px]';
    }
}

function toggleFocusOnly() {
    state.onlyFocus = !state.onlyFocus;
    // 我关注的是是一个独立的筛选条件，不影响排序
    var focusBtn = document.getElementById('focusOnlyBtn');
    var closeIcon = document.getElementById('focusCloseIcon');
    if (state.onlyFocus) {
        focusBtn.className = 'text-[10px] text-primary font-medium bg-green-50 border border-green-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1';
        closeIcon.classList.remove('hidden');
    } else {
        focusBtn.className = 'text-[10px] text-gray-500 font-medium bg-gray-50 border border-gray-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1';
        closeIcon.classList.add('hidden');
    }
    renderList();
}

function toggleSortDropdown() {
    var dropdown = document.getElementById('sortDropdown');
    var arrow = document.getElementById('sortArrow');
    if (dropdown.classList.contains('hidden')) {
        dropdown.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
    } else {
        dropdown.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
    }
}

function setSortOption(value) {
    // 更新状态
    state.activeTab = value; // 'latest' | 'oldest' | 'nearest' | 'farthest'
    state.sort = value;

    // 更新下拉菜单标签
    var labelMap = {
        'latest': '最新发布',
        'oldest': '最晚发布',
        'nearest': '距离最近',
        'farthest': '距离最远'
    };
    document.getElementById('sortLabel').textContent = labelMap[value];

    // 更新勾选状态
    document.getElementById('check-latest').classList.add('opacity-0');
    document.getElementById('check-oldest').classList.add('opacity-0');
    document.getElementById('check-nearest').classList.add('opacity-0');
    document.getElementById('check-farthest').classList.add('opacity-0');
    document.getElementById('check-' + value).classList.remove('opacity-0');

    // 关闭下拉菜单
    toggleSortDropdown();

    // 重新渲染列表
    renderList();
}

function resetAllFilters() {
    state.sort = 'latest';
    state.activeTab = 'latest';
    state.timeRange = 'all';
    state.customDateStart = '';
    state.customDateEnd = '';
    state.category = '全部';
    state.maxDistance = 'all';
    state.onlyFocus = false;
    state.keyword = '';
    document.getElementById('searchInput').value = '';

    // 重置下拉排序
    document.getElementById('sortLabel').textContent = '最新发布';
    document.getElementById('check-latest').classList.remove('opacity-0');
    document.getElementById('check-oldest').classList.add('opacity-0');
    document.getElementById('check-nearest').classList.add('opacity-0');
    document.getElementById('check-farthest').classList.add('opacity-0');

    // 重置我关注的按钮
    document.getElementById('focusOnlyBtn').className = 'text-[10px] text-gray-500 font-medium bg-gray-50 border border-gray-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1';
    document.getElementById('focusCloseIcon').classList.add('hidden');

    renderList();
    renderFilterDot();
}

function renderSortBtns() {
    // 根据当前状态更新下拉菜单显示
    var labelMap = {
        'latest': '最新发布',
        'oldest': '最晚发布',
        'nearest': '距离最近',
        'farthest': '距离最远'
    };
    document.getElementById('sortLabel').textContent = labelMap[state.activeTab] || '最新发布';

    // 更新勾选状态
    document.getElementById('check-latest').classList.add('opacity-0');
    document.getElementById('check-oldest').classList.add('opacity-0');
    document.getElementById('check-nearest').classList.add('opacity-0');
    document.getElementById('check-farthest').classList.add('opacity-0');
    document.getElementById('check-' + (state.activeTab || 'latest')).classList.remove('opacity-0');

    // 更新我关注的按钮状态
    var focusBtn = document.getElementById('focusOnlyBtn');
    var closeIcon = document.getElementById('focusCloseIcon');
    if (state.onlyFocus) {
        focusBtn.className = 'text-[10px] text-primary font-medium bg-green-50 border border-green-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1';
        closeIcon.classList.remove('hidden');
    } else {
        focusBtn.className = 'text-[10px] text-gray-500 font-medium bg-gray-50 border border-gray-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1';
        closeIcon.classList.add('hidden');
    }
}

function openFilter() {
    draftFilter = {
        timeRange: state.timeRange,
        customDateStart: state.customDateStart,
        customDateEnd: state.customDateEnd,
        category: state.category,
        maxDistance: state.maxDistance
    };
    renderFilterOptions();
    var dateBox = document.getElementById('customDateBox');
    var dateStart = document.getElementById('customDateStart');
    var dateEnd = document.getElementById('customDateEnd');
    if (dateBox) {
        if (draftFilter.timeRange === 'custom') {
            dateBox.classList.remove('hidden');
            if (dateStart) dateStart.value = draftFilter.customDateStart || '';
            if (dateEnd) dateEnd.value = draftFilter.customDateEnd || '';
        } else {
            dateBox.classList.add('hidden');
        }
    }
    document.getElementById('filterMask').classList.remove('hidden');
    document.getElementById('filterSheet').classList.remove('hidden');
}

function closeFilter() {
    document.getElementById('filterMask').classList.add('hidden');
    document.getElementById('filterSheet').classList.add('hidden');
}

function pickFilter(key, value) {
    draftFilter[key] = value;
    renderFilterOptions();

    if (key === 'timeRange' && value === 'custom') {
        var dateBox = document.getElementById('customDateBox');
        if (dateBox) {
            dateBox.classList.remove('hidden');
        }
    } else if (key === 'timeRange') {
        var dateBox = document.getElementById('customDateBox');
        if (dateBox) {
            dateBox.classList.add('hidden');
        }
    }
}

function onCustomDateChange() {
    var dateStart = document.getElementById('customDateStart');
    var dateEnd = document.getElementById('customDateEnd');
    if (dateStart) draftFilter.customDateStart = dateStart.value;
    if (dateEnd) draftFilter.customDateEnd = dateEnd.value;
}

function pickFilterByDataset(el) {
    if (!el) return;
    var key = el.getAttribute('data-key');
    var value = el.getAttribute('data-value');
    if (!key) return;
    pickFilter(key, value || '');
}

function optionClass(active) {
    return active
        ? 'text-[11px] text-primary font-medium bg-primary/5 border border-primary/20 rounded-lg px-3 py-1.5'
        : 'text-[11px] text-gray-500 font-medium bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5';
}

function renderFilterOptions() {
    var timeGroup = document.getElementById('timeGroup');
    var categoryGroup = document.getElementById('categoryGroup');
    var distanceGroup = document.getElementById('distanceGroup');

    timeGroup.innerHTML = FILTER_META.timeRange.map(function(item) {
        return '<button type="button" data-key="timeRange" data-value="' + item.value + '" class="' + optionClass(draftFilter.timeRange === item.value) + '" onclick="pickFilterByDataset(this)">' + item.label + '</button>';
    }).join('');

    categoryGroup.innerHTML = FILTER_META.category.map(function(name) {
        var cls = draftFilter.category === name
            ? 'text-[11px] text-primary font-medium bg-primary/5 border border-primary/20 rounded-lg py-1.5'
            : 'text-[11px] text-gray-500 font-medium bg-gray-50 border border-gray-200 rounded-lg py-1.5';
        return '<button type="button" data-key="category" data-value="' + name + '" class="' + cls + '" onclick="pickFilterByDataset(this)">' + name + '</button>';
    }).join('');

    distanceGroup.innerHTML = FILTER_META.maxDistance.map(function(item) {
        return '<button type="button" data-key="maxDistance" data-value="' + item.value + '" class="' + optionClass(draftFilter.maxDistance === item.value) + '" onclick="pickFilterByDataset(this)">' + item.label + '</button>';
    }).join('');
}

function resetFilter() {
    draftFilter = { timeRange: 'all', customDateStart: '', customDateEnd: '', category: '全部', maxDistance: 'all' };
    renderFilterOptions();
    var dateBox = document.getElementById('customDateBox');
    var dateStart = document.getElementById('customDateStart');
    var dateEnd = document.getElementById('customDateEnd');
    if (dateBox) dateBox.classList.add('hidden');
    if (dateStart) dateStart.value = '';
    if (dateEnd) dateEnd.value = '';
}

function applyFilter() {
    state.timeRange = draftFilter.timeRange;
    state.customDateStart = draftFilter.customDateStart;
    state.customDateEnd = draftFilter.customDateEnd;
    state.category = draftFilter.category;
    state.maxDistance = draftFilter.maxDistance;
    closeFilter();
    renderList();
    renderFilterDot();
}

function hasActiveFilters() {
    return state.timeRange !== 'all' || state.category !== '全部' || state.maxDistance !== 'all';
}

function renderFilterDot() {
    var dot = document.getElementById('filterDot');
    if (!dot) return;
    if (hasActiveFilters()) {
        dot.classList.remove('hidden');
    } else {
        dot.classList.add('hidden');
    }
}

function isKeywordMatched(item, keywords) {
    if (!keywords.length) return false;
    var haystack = [item.category, item.content, item.location, item.ownerName].join(' ').toLowerCase();
    return keywords.some(function(k) {
        return haystack.indexOf(String(k).toLowerCase()) !== -1;
    });
}

function isInTimeRange(iso, range, customDateStart, customDateEnd) {
    if (range === 'all') return true;
    var t = new Date(iso || '').getTime();
    if (Number.isNaN(t)) return false;
    var now = Date.now();
    if (range === '1h') return now - t <= 60 * 60 * 1000;
    if (range === '3d') return now - t <= 3 * 24 * 60 * 60 * 1000;
    if (range === 'today') {
        var d = new Date(t);
        var n = new Date(now);
        return d.getFullYear() === n.getFullYear() && d.getMonth() === n.getMonth() && d.getDate() === n.getDate();
    }
    if (range === 'custom') {
        var d = new Date(t);
        d.setHours(0, 0, 0, 0);

        if (customDateStart) {
            var start = new Date(customDateStart);
            start.setHours(0, 0, 0, 0);
            if (d < start) return false;
        }
        if (customDateEnd) {
            var end = new Date(customDateEnd);
            end.setHours(23, 59, 59, 999);
            if (d > end) return false;
        }
        return true;
    }
    return true;
}

function readList() {
    // 1. 获取原始数据（始终从 fallbackList 获取，避免 store 预排序）
    var list = fallbackList.slice();

    // 2. 应用所有筛选条件
    if (state.category !== '全部') {
        list = list.filter(function(item) { return item.category === state.category; });
    }

    list = list.filter(function(item) {
        return isInTimeRange(item.createdAt, state.timeRange, state.customDateStart, state.customDateEnd);
    });

    if (state.maxDistance !== 'all') {
        var max = Number(state.maxDistance);
        list = list.filter(function(item) {
            return Number(item.distanceKm || 999) <= max;
        });
    }

    if (state.keyword) {
        var key = state.keyword.toLowerCase();
        list = list.filter(function(item) {
            var haystack = [item.category, item.content, item.location, item.ownerName].join(' ').toLowerCase();
            return haystack.indexOf(key) !== -1;
        });
    }

    if (state.onlyFocus) {
        list = list.filter(function(item) {
            return isKeywordMatched(item, myKeywords);
        });
    }

    // 3. 根据当前排序状态重新排序（这是关键！）
    if (state.sort === 'nearest') {
        // 距离最近：按距离升序
        list.sort(function(a, b) {
            return Number(a.distanceKm || 999) - Number(b.distanceKm || 999);
        });
    } else if (state.sort === 'farthest') {
        // 距离最远：按距离降序
        list.sort(function(a, b) {
            return Number(b.distanceKm || 0) - Number(a.distanceKm || 0);
        });
    } else if (state.sort === 'oldest') {
        // 最晚发布：按时间升序（最早的在前面）
        list.sort(function(a, b) {
            var timeA = new Date(a.createdAt || 0).getTime();
            var timeB = new Date(b.createdAt || 0).getTime();
            return timeA - timeB;
        });
    } else {
        // 最新发布：按时间倒序（最新的在前面）
        list.sort(function(a, b) {
            var timeA = new Date(a.createdAt || 0).getTime();
            var timeB = new Date(b.createdAt || 0).getTime();
            return timeB - timeA;
        });
    }

    return list;
}

function formatAgo(iso) {
    var t = new Date(iso || '').getTime();
    if (Number.isNaN(t)) return '-';
    var diff = Math.max(0, Date.now() - t);
    var minutes = Math.floor(diff / 60000);
    if (minutes < 1) return '刚刚';
    if (minutes < 60) return minutes + '分钟前';
    var hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + '小时前';
    var days = Math.floor(hours / 24);
    return days + '天前';
}

function formatPrice(item) {
    if (item.price === null || item.price === undefined || item.price === '') return '面议';
    var unit = item.unit || '斤';
    return '¥' + Number(item.price).toFixed(2) + '/' + unit;
}

function categoryTagClass(category) {
    if (category === '水果') return 'bg-red-50 text-red-500';
    if (category === '蔬菜') return 'bg-green-50 text-green-500';
    if (category === '粮油') return 'bg-amber-50 text-amber-500';
    if (category === '禽蛋') return 'bg-violet-50 text-violet-500';
    if (category === '肉类') return 'bg-orange-50 text-orange-500';
    if (category === '其他') return 'bg-gray-100 text-gray-400';
    return 'bg-gray-100 text-gray-400';
}

function showToast(msg) {
    var tip = document.getElementById('toastTip');
    tip.textContent = msg;
    tip.classList.remove('opacity-0');
    tip.classList.add('opacity-100');
    clearTimeout(showToast.timer);
    showToast.timer = setTimeout(function() {
        tip.classList.remove('opacity-100');
        tip.classList.add('opacity-0');
    }, 1700);
}

function renderList() {
    myKeywords = loadKeywords();
    updateKeywordCount();

    var list = readList();
    var box = document.getElementById('demandList');

    if (state.onlyFocus && myKeywords.length === 0) {
        box.innerHTML = '' +
            '<div class="glass-card rounded-xl p-5 text-center mt-2">' +
                '<div class="text-sm text-gray-500 mb-1">未设置关注关键词</div>' +
                '<div class="text-[11px] text-gray-400 mb-3">设置关键词后，可快速查看相关销售需求</div>' +
                '<a href="buyer-keywords.html?source=market" class="inline-block text-[11px] text-primary font-medium bg-green-50 border border-green-200 rounded-full px-4 py-1.5 no-underline" style="text-decoration:none;">去设置关键词 ></a>' +
            '</div>';
        return;
    }

    if (!list.length) {
        box.innerHTML = '' +
            '<div class="glass-card rounded-xl p-6 text-center mt-2">' +
                '<div class="text-sm text-gray-500 mb-1">暂无匹配需求</div>' +
                '<div class="text-[11px] text-gray-400">可尝试调整筛选条件或清空搜索关键词</div>' +
            '</div>';
        return;
    }

    box.innerHTML = list.map(function(item) {
        var encodeName = encodeURIComponent(item.ownerName || '发布者');
        var encodePhone = encodeURIComponent(item.ownerMobile || '-');
        var detailHref = 'buyer-demand-detail.html?id=' + encodeURIComponent(item.id || '');
        var statusLabel = item.status === 'active' ? '进行中' : '已下架';
        var statusClass = item.status === 'active' ? 'bg-primary/10 text-primary' : 'bg-gray-100 text-gray-500';
        return '' +
            '<div class="glass-card rounded-xl p-3.5 pr-10 relative">' +
                '<a href="' + detailHref + '" class="absolute inset-0 no-underline" style="text-decoration:none;" aria-label="查看详情"></a>' +
                '<div class="flex items-center justify-between mb-1.5">' +
                    '<div class="flex items-center gap-1.5">' +
                        '<span class="text-[10px] px-1.5 py-0.5 rounded font-medium ' + categoryTagClass(item.category) + '">' + (item.category || '其他') + '</span>' +
                        '<span class="text-[10px] text-gray-500 bg-gray-50 px-1.5 py-0.5 rounded">余' + String(item.qty || 0) + (item.unit || '斤') + '</span>' +
                    '</div>' +
                    '<span class="text-[10px] ' + statusClass + ' px-1.5 py-0.5 rounded font-medium absolute right-3 top-3.5">' + statusLabel + '</span>' +
                '</div>' +
                '<div class="text-sm text-gray-800 font-medium mb-2 leading-5 truncate">' + (item.content || '-') + '</div>' +
                '<div class="flex items-center justify-between">' +
                    '<div class="flex items-center gap-3">' +
                        '<span class="text-xs text-primary font-bold" style="font-family:Poppins;">' + formatPrice(item) + '</span>' +
                        '<span class="text-[10px] text-gray-400"><i class="fas fa-location-dot mr-0.5"></i>' + Number(item.distanceKm || 0).toFixed(1) + 'km</span>' +
                    '</div>' +
                    '<div class="flex items-center gap-2 absolute right-3 bottom-3">' +
                        '<button class="text-[10px] text-white font-medium px-2.5 py-1 bg-primary rounded-full z-10 shadow-sm active:opacity-90" onclick="event.preventDefault();event.stopPropagation();openContact(\'' + encodeName + '\',\'' + encodePhone + '\')">联系</button>' +
                        '<span class="text-[10px] text-gray-400">' + formatAgo(item.createdAt) + '</span>' +
                    '</div>' +
                '</div>' +
                '<i class="fas fa-chevron-right text-xs text-gray-300 absolute right-3 top-1/2 -translate-y-1/2"></i>' +
            '</div>';
    }).join('');
}

function openContact(encodedName, encodedPhone) {
    var name = decodeURIComponent(encodedName || '');
    var phone = decodeURIComponent(encodedPhone || '');
    currentContactPhone = phone;
    document.getElementById('contactName').textContent = name || '发布者';
    document.getElementById('contactPhone').textContent = phone || '-';
    document.getElementById('callLink').setAttribute('href', 'tel:' + (phone || '').replace(/\*/g, ''));
    document.getElementById('contactMask').classList.remove('hidden');
    document.getElementById('contactSheet').classList.remove('hidden');
}

function copyContact() {
    if (!currentContactPhone || currentContactPhone === '-') return;
    var text = currentContactPhone;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            showToast('号码已复制');
        }).catch(function() {
            showToast('复制失败，请手动复制');
        });
        return;
    }
    showToast('当前环境不支持自动复制');
}

function closeContact() {
    document.getElementById('contactMask').classList.add('hidden');
    document.getElementById('contactSheet').classList.add('hidden');
}

// 初始化：根据当前状态设置正确的 activeTab
if (state.sort === 'nearest') {
    state.activeTab = 'nearest';
} else if (state.sort === 'farthest') {
    state.activeTab = 'farthest';
} else if (state.sort === 'oldest') {
    state.activeTab = 'oldest';
} else {
    state.activeTab = 'latest'; // 默认最新发布
}

// 点击页面其他地方关闭排序下拉菜单
document.addEventListener('click', function(e) {
    var dropdown = document.getElementById('sortDropdown');
    var btn = document.getElementById('sortDropdownBtn');
    if (!dropdown.classList.contains('hidden') &&
        !dropdown.contains(e.target) &&
        !btn.contains(e.target)) {
        dropdown.classList.add('hidden');
        document.getElementById('sortArrow').style.transform = 'rotate(0deg)';
    }
});

// 初始化勾选状态（默认选中最新发布）
document.getElementById('check-latest').classList.remove('opacity-0');

updateKeywordCount();
renderSortBtns();
renderFilterDot();

// 检查URL参数，如果有focus=1则自动激活"我关注的"状态
(function checkFocusParam() {
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('focus') === '1') {
        state.onlyFocus = true;
        var focusBtn = document.getElementById('focusOnlyBtn');
        var closeIcon = document.getElementById('focusCloseIcon');
        if (focusBtn && closeIcon) {
            focusBtn.className = 'text-[10px] text-primary font-medium bg-green-50 border border-green-200 rounded-full px-3 py-1.5 whitespace-nowrap flex items-center gap-1';
            closeIcon.classList.remove('hidden');
        }
    }
})();

renderList();
</script>
</body>
</html>
